name: AI Instructions & Agent Sync

# Consolidated workflow for all AI instruction and agent synchronization
# Combines:
# - Monthly agent sync (Claude Code â†’ Copilot)
# - Quarterly metrics sync (update stats in instruction docs)
on:
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type of sync to run'
        required: true
        default: 'both'
        type: choice
        options:
          - agents
          - metrics
          - both

  schedule:
    # Monthly agent sync: 1st of every month at 9:00 UTC
    - cron: '0 9 1 * *'

    # Quarterly metrics sync: First Monday of Jan/Apr/Jul/Oct at 16:00 UTC
    - cron: '0 16 1-7 1,4,7,10 1'

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  # Determine which jobs to run based on trigger
  determine-jobs:
    runs-on: ubuntu-latest
    outputs:
      run_agents: ${{ steps.determine.outputs.run_agents }}
      run_metrics: ${{ steps.determine.outputs.run_metrics }}
    steps:
      - name: Determine which jobs to run
        id: determine
        run: |
          # Default to false
          RUN_AGENTS="false"
          RUN_METRICS="false"

          # Check if manual trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SYNC_TYPE="${{ github.event.inputs.sync_type }}"
            if [ "$SYNC_TYPE" == "agents" ] || [ "$SYNC_TYPE" == "both" ]; then
              RUN_AGENTS="true"
            fi
            if [ "$SYNC_TYPE" == "metrics" ] || [ "$SYNC_TYPE" == "both" ]; then
              RUN_METRICS="true"
            fi

          # Check if scheduled trigger
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            # Monthly cron (1st of month) = agent sync
            if [ "$(date +%d)" == "01" ]; then
              RUN_AGENTS="true"
            fi

            # Quarterly cron (first Monday of Q1/Q2/Q3/Q4) = metrics sync
            MONTH=$(date +%m)
            if [ "$MONTH" == "01" ] || [ "$MONTH" == "04" ] || [ "$MONTH" == "07" ] || [ "$MONTH" == "10" ]; then
              DAY=$(date +%d)
              if [ "$DAY" -ge 1 ] && [ "$DAY" -le 7 ]; then
                RUN_METRICS="true"
              fi
            fi
          fi

          echo "run_agents=$RUN_AGENTS" >> $GITHUB_OUTPUT
          echo "run_metrics=$RUN_METRICS" >> $GITHUB_OUTPUT

          echo "### Job Determination" >> $GITHUB_STEP_SUMMARY
          echo "- Run agents sync: $RUN_AGENTS" >> $GITHUB_STEP_SUMMARY
          echo "- Run metrics sync: $RUN_METRICS" >> $GITHUB_STEP_SUMMARY

  # Agent synchronization (Claude Code â†’ Copilot)
  sync-agents:
    needs: determine-jobs
    if: needs.determine-jobs.outputs.run_agents == 'true'
    runs-on: ubuntu-latest
    name: Sync AI Agents (Claude Code â†’ Copilot)
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Run agent sync
        run: npm run sync:agents
        continue-on-error: false

      - name: Check sync status
        run: npm run sync:agents -- --status
        if: always()

      - name: Generate monthly learning report
        run: npm run learning:report -- --month $(date +%Y-%m)
        continue-on-error: true

      - name: Commit sync changes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add sync reports
          git add sync-report-*.md || true

          if git diff --quiet --cached; then
            echo "No changes detected"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: sync DCYFR agents (primary â†’ secondary model)"
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        if: steps.commit.outputs.changes == 'true'
        with:
          commit-message: 'chore: sync DCYFR agents (Claude Code â†’ Copilot)'
          title: 'chore: monthly agent sync'
          body: |
            ## Monthly DCYFR Agent Synchronization

            This PR contains monthly synchronization of AI agents across implementations.

            **Sync Direction:** Claude Code (ðŸ”´ Primary) â†’ Copilot (ðŸŸ¡ Secondary)

            ### Changes
            - Updated Copilot quick reference from Claude Code patterns
            - Generated sync validation report
            - All implementations validated for consistency
            - Monthly learning report generated (available in artifacts)

            ### Artifacts
            - **Sync reports:** `agent-sync-reports` artifact
            - **Learning report:** `learning-report-${{ github.run_number }}` artifact (90-day retention)

            ### Strategy
            See [`docs/ai/AGENT_SYNC_STRATEGY.md`](./docs/ai/AGENT_SYNC_STRATEGY.md) for sync strategy and [`docs/ai/AGENT_UNIFICATION_ANALYSIS.md`](./docs/ai/AGENT_UNIFICATION_ANALYSIS.md) for rationale.

            **Automated by:** `ai-sync-consolidated.yml` (monthly, 1st of month 9:00 UTC)
          branch: sync/agents-${{ github.run_number }}
          delete-branch: true
          labels: |
            documentation
            automated
            ai-agents

      - name: Publish sync report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: agent-sync-reports-${{ github.run_number }}
          path: sync-report-*.md
          if-no-files-found: ignore
          retention-days: 30

      - name: Publish learning report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: learning-report-${{ github.run_number }}
          path: .github/agents/learning-data/monthly-reports/*.md
          if-no-files-found: ignore
          retention-days: 90

  # Metrics synchronization (update instruction docs with current stats)
  sync-metrics:
    needs: determine-jobs
    if: needs.determine-jobs.outputs.run_metrics == 'true'
    runs-on: ubuntu-latest
    name: Sync Metrics to Instructions
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Sync AI instructions with current metrics
        run: npm run sync:ai

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
            git diff --name-only >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Pull Request with synced docs
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(docs): sync AI instructions with current metrics

            - Update test statistics
            - Refresh MCP server status
            - Capture latest design token compliance
            - Sync Lighthouse performance baselines
          title: 'chore(docs): quarterly sync of AI instructions and metrics'
          body: |
            ## Quarterly AI Instruction Sync

            This PR automatically syncs instruction documentation with current project state.

            **Changes:**
            - âœ… Test statistics updated
            - âœ… MCP server status refreshed
            - âœ… Design token compliance captured
            - âœ… Lighthouse baselines synced

            **Generated by:** `npm run sync:ai`
            **Schedule:** Quarterly (first Monday of Jan/Apr/Jul/Oct)

            Please review for accuracy and merge to keep documentation current.
          branch: 'chore/sync-ai-instructions-${{ github.run_number }}'
          delete-branch: true
          labels: |
            documentation
            automated
            ai-instructions
          reviewers: |
            dcyfr

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“š Metrics Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.changed }}" == "true" ]]; then
            echo "âœ… Changes detected - Pull Request created" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No changes needed - Instructions are current" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Last sync:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # Validation runs after all syncs complete
  validate:
    needs: [sync-agents, sync-metrics]
    if: always() && (needs.sync-agents.result == 'success' || needs.sync-metrics.result == 'success')
    runs-on: ubuntu-latest
    name: Validate Instruction Files

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Validate instruction files
        run: |
          if [ -f scripts/validation/validate-instructions.mjs ]; then
            node scripts/validation/validate-instructions.mjs
          else
            echo "No validation script found, skipping..."
          fi
        continue-on-error: true

      - name: Check MCP servers
        run: |
          if [ -f scripts/ci/check-mcp-servers.mjs ]; then
            node scripts/ci/check-mcp-servers.mjs --no-auth || echo "MCP checks completed"
          else
            echo "No MCP script found, proceeding..."
          fi
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "### âœ… Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All instruction files validated for consistency and correctness." >> $GITHUB_STEP_SUMMARY
