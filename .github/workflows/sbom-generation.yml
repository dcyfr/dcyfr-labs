name: SBOM Generation

# Automated Software Bill of Materials generation for SOC2 Type 2 compliance
# Part of third-party risk management and vulnerability tracking controls

on:
  # Trigger on release tags
  push:
    tags:
      - 'v*'
      - '2*' # Calendar versioning (YYYY.MM.DD)

  # Monthly scheduled generation (1st of month, 2 AM UTC)
  schedule:
    - cron: '0 2 1 * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      generate_all_formats:
        description: 'Generate all SBOM formats (CycloneDX, SPDX, Combined)'
        required: false
        default: true
        type: boolean
      upload_to_releases:
        description: 'Upload SBOMs to GitHub Releases (tag required)'
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for same ref
concurrency:
  group: sbom-generation-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write # For creating release assets
  security-events: write # For uploading SBOM to dependency graph
  pull-requests: write # For PR comments

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Make script executable
        run: chmod +x scripts/security/generate-sbom.mjs

      - name: Generate SBOM
        id: generate
        run: |
          node scripts/security/generate-sbom.mjs

          # Capture generated filenames
          TIMESTAMP=$(date +%Y-%m-%d)
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "cyclonedx_file=docs/security/sbom/sbom-cyclonedx-${TIMESTAMP}.json" >> $GITHUB_OUTPUT
          echo "spdx_file=docs/security/sbom/sbom-spdx-${TIMESTAMP}.json" >> $GITHUB_OUTPUT
          echo "combined_file=docs/security/sbom/sbom-combined-${TIMESTAMP}.json" >> $GITHUB_OUTPUT
          echo "summary_file=docs/security/sbom/sbom-summary-${TIMESTAMP}.md" >> $GITHUB_OUTPUT

      - name: Validate SBOM files
        run: |
          TIMESTAMP="${{ steps.generate.outputs.timestamp }}"

          # Check files exist
          if [ ! -f "docs/security/sbom/sbom-cyclonedx-${TIMESTAMP}.json" ]; then
            echo "âŒ CycloneDX SBOM not generated"
            exit 1
          fi

          if [ ! -f "docs/security/sbom/sbom-combined-${TIMESTAMP}.json" ]; then
            echo "âŒ Combined SBOM not generated"
            exit 1
          fi

          # Validate JSON structure
          jq empty "docs/security/sbom/sbom-cyclonedx-${TIMESTAMP}.json" || {
            echo "âŒ CycloneDX SBOM is invalid JSON"
            exit 1
          }

          jq empty "docs/security/sbom/sbom-combined-${TIMESTAMP}.json" || {
            echo "âŒ Combined SBOM is invalid JSON"
            exit 1
          }

          echo "âœ… SBOM files validated"

      - name: Generate summary
        run: |
          TIMESTAMP="${{ steps.generate.outputs.timestamp }}"
          COMBINED_FILE="docs/security/sbom/sbom-combined-${TIMESTAMP}.json"

          echo "# ðŸ“¦ SBOM Generation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Files Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CycloneDX SBOM: \`sbom-cyclonedx-${TIMESTAMP}.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SPDX SBOM: \`sbom-spdx-${TIMESTAMP}.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Combined Enriched SBOM: \`sbom-combined-${TIMESTAMP}.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Summary Report: \`sbom-summary-${TIMESTAMP}.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Summary Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RUNTIME_DEPS=$(jq '.summary.runtimeDependencies' "$COMBINED_FILE")
          DEV_DEPS=$(jq '.summary.devDependencies' "$COMBINED_FILE")
          TOTAL_DEPS=$(jq '.summary.totalDependencies' "$COMBINED_FILE")
          SERVICES=$(jq '.summary.thirdPartyServices' "$COMBINED_FILE")

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime Dependencies | $RUNTIME_DEPS |" >> $GITHUB_STEP_SUMMARY
          echo "| Dev Dependencies | $DEV_DEPS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Dependencies** | **$TOTAL_DEPS** |" >> $GITHUB_STEP_SUMMARY
          echo "| Third-Party Services | $SERVICES |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## SOC2 Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Trust Service Criteria:**" >> $GITHUB_STEP_SUMMARY
          echo "- SC3.2: Security testing and vulnerability management" >> $GITHUB_STEP_SUMMARY
          echo "- PI1.1: Data validation and processing integrity" >> $GITHUB_STEP_SUMMARY
          echo "- C2.1: Third-party service inventory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Retention:** 24 months (SOC2 Type 2 requirement)" >> $GITHUB_STEP_SUMMARY

      - name: Upload SBOM to Dependency Graph
        if: github.event_name != 'pull_request'
        continue-on-error: true
        run: |
          TIMESTAMP="${{ steps.generate.outputs.timestamp }}"
          CYCLONEDX_FILE="docs/security/sbom/sbom-cyclonedx-${TIMESTAMP}.json"

          # GitHub Dependency Submission API
          # https://docs.github.com/en/code-security/supply-chain-security/understanding-your-software-supply-chain/using-the-dependency-submission-api

          echo "ðŸ“¤ Uploading SBOM to GitHub Dependency Graph..."
          echo "   This enables automatic vulnerability scanning"

          # Note: This requires a GitHub App or PAT with appropriate permissions
          # For now, we'll skip this step as it requires additional setup

      - name: Commit SBOM files
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          TIMESTAMP="${{ steps.generate.outputs.timestamp }}"

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add docs/security/sbom/sbom-*.json
          git add docs/security/sbom/sbom-*.md

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(security): generate SBOM ${TIMESTAMP}" \
              -m "" \
              -m "CycloneDX SBOM (industry standard)" \
              -m "SPDX SBOM (compliance)" \
              -m "Combined enriched SBOM (all dependencies + services)" \
              -m "" \
              -m "Part of SOC2 Type 2 third-party risk management." \
              -m "" \
              -m "[skip ci]"

            git push origin ${{ github.ref_name }}
            echo "âœ… SBOM files committed and pushed"
          fi

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.generate.outputs.timestamp }}
          path: |
            docs/security/sbom/sbom-cyclonedx-${{ steps.generate.outputs.timestamp }}.json
            docs/security/sbom/sbom-spdx-${{ steps.generate.outputs.timestamp }}.json
            docs/security/sbom/sbom-combined-${{ steps.generate.outputs.timestamp }}.json
            docs/security/sbom/sbom-summary-${{ steps.generate.outputs.timestamp }}.md
          retention-days: 730 # 24 months (SOC2 Type 2 requirement)

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/') && (github.event.inputs.upload_to_releases == 'true' || github.event_name == 'push')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            docs/security/sbom/sbom-cyclonedx-${{ steps.generate.outputs.timestamp }}.json
            docs/security/sbom/sbom-combined-${{ steps.generate.outputs.timestamp }}.json
            docs/security/sbom/sbom-summary-${{ steps.generate.outputs.timestamp }}.md
          body: |
            ## ðŸ“¦ Software Bill of Materials (SBOM)

            This release includes automatically generated SBOMs for SOC2 Type 2 compliance:

            - **CycloneDX SBOM** - Industry standard format for vulnerability scanning
            - **Combined SBOM** - Comprehensive inventory including third-party services
            - **Summary Report** - Human-readable SBOM overview

            ### Key Metrics
            - Total Dependencies: Documented in combined SBOM
            - Third-Party Services: 12 external integrations
            - SOC2 Controls: SC3.2, PI1.1, C2.1

            For details, see `docs/security/sbom/README.md`

      - name: Cleanup old SBOMs
        if: github.event_name == 'schedule'
        run: |
          # Remove SBOMs older than 24 months (SOC2 retention requirement)
          echo "ðŸ—‘ï¸  Cleaning up SBOMs older than 24 months..."

          find docs/security/sbom -name "sbom-*.json" -o -name "sbom-*.md" | while read file; do
            # Extract date from filename (format: sbom-*-YYYY-MM-DD.*)
            FILE_DATE=$(basename "$file" | grep -oP '\d{4}-\d{2}-\d{2}')

            if [ -n "$FILE_DATE" ]; then
              FILE_TIMESTAMP=$(date -d "$FILE_DATE" +%s 2>/dev/null || echo "0")
              CUTOFF_TIMESTAMP=$(date -d "24 months ago" +%s)

              if [ "$FILE_TIMESTAMP" -lt "$CUTOFF_TIMESTAMP" ] && [ "$FILE_TIMESTAMP" != "0" ]; then
                echo "   Removing old SBOM: $file (${FILE_DATE})"
                git rm "$file"
              fi
            fi
          done

          # Commit removals if any
          if ! git diff --cached --quiet; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git commit -m "chore(security): cleanup SBOMs older than 24 months" \
              -m "" \
              -m "SOC2 Type 2 retention policy enforcement." \
              -m "" \
              -m "[skip ci]"
            git push origin ${{ github.ref_name }}
            echo "âœ… Old SBOMs removed"
          else
            echo "â„¹ï¸  No old SBOMs to remove"
          fi

  notify-on-failure:
    needs: generate-sbom
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”’ SBOM Generation Failed';
            const body = `## SBOM Generation Failure

            The automated SBOM generation workflow has failed.

            **Details:**
            - **Run:** ${context.runId}
            - **Trigger:** ${context.eventName}
            - **Branch:** ${context.ref}
            - **Commit:** ${context.sha}

            **Impact:**
            This may affect SOC2 Type 2 compliance for third-party risk management.

            **Action Required:**
            1. Review workflow logs
            2. Fix SBOM generation script if needed
            3. Manually generate SBOM: \`npm run sbom:generate\`
            4. Verify all SBOM formats are generated

            **Reference:**
            - SOC2 Plan: \`docs/security/.private/soc2-compliance-plan-2026-01-31.md\`
            - SBOM Docs: \`docs/security/sbom/README.md\`
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,sbom,compliance'
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'sbom', 'compliance', 'automation']
              });
            }
