name: Lighthouse CI

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - 'next.config.ts'
      - 'lighthouserc.json'
      - '.github/workflows/lighthouse-ci.yml'
  workflow_dispatch:

# Cancel in-progress runs for same PR
concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v1
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          VERCEL_AUTOMATION_BYPASS_SECRET: op://Development/dcyfr-labs-vercel-automation-bypass-secret/password

      - name: Update baseline browser mapping
        run: npm run update:baseline
        env:
          NODE_ENV: production


      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            .next/static
          key: ${{ runner.os }}-nextjs-lighthouse-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**', 'public/**') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-lighthouse-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-lighthouse-

      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production

      - name: Start production server
        run: npm start &
        env:
          NODE_ENV: production

      - name: Wait for server
        run: npx wait-on http://localhost:3000 --timeout 30000

      - name: Run Lighthouse CI
        run: npm run lhci:autorun
        # VERCEL_AUTOMATION_BYPASS_SECRET loaded from 1Password
        continue-on-error: true

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 14

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const resultsPath = '.lighthouseci/lighthouse-results.json';
            
            if (!fs.existsSync(resultsPath)) {
              console.log('No Lighthouse results found');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            
            // Build comment with results
            let comment = '## üìä Lighthouse CI Results\n\n';
            
            if (results.runs && results.runs.length > 0) {
              const run = results.runs[0];
              const lhr = run.lhr;
              
              if (lhr && lhr.categories) {
                comment += '| Category | Score | Budget |\n';
                comment += '|----------|-------|--------|\n';
                
                const categories = lhr.categories;
                const budgets = {
                  'performance': 90,
                  'accessibility': 95,
                  'best-practices': 85,
                  'seo': 90
                };
                
                for (const [key, cat] of Object.entries(categories)) {
                  const score = Math.round(cat.score * 100);
                  const budget = budgets[key] || 'N/A';
                  const status = score >= budget ? '‚úÖ' : '‚ö†Ô∏è';
                  comment += `| ${cat.title} | ${score} | ${budget} ${status} |\n`;
                }
              }
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if performance regressed
        if: always()
        run: npm run lhci:assert
