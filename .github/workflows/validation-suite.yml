name: Validation Suite

# Consolidated validation workflow combining:
# - validate-content.yml (Markdown validation)
# - validate-botid.yml (BotID setup validation)
# - validate-dependabot.yml (Dependabot config validation)
#
# Optimized to share npm ci and run validations in parallel

on:
  pull_request:
    paths:
      - 'src/content/**/*.mdx'
      - 'docs/**/*.md'
      - '.github/dependabot.yml'
      - 'scripts/validation/**/*'
      - 'scripts/changelog*.mjs'
      - 'CHANGELOG.md'
      - 'vercel.json'
  push:
    branches: [main, preview]
    paths:
      - 'src/content/**/*.mdx'
      - 'docs/**/*.md'
      - '.github/dependabot.yml'
      - 'scripts/changelog*.mjs'
      - 'CHANGELOG.md'
  schedule:
    # Weekly validation on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

concurrency:
  group: validation-suite-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  # Single setup job - install dependencies once
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Cache node_modules
        uses: actions/cache/save@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}

  # Validation jobs run in parallel
  content-validation:
    needs: setup
    name: Content Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Validate Markdown content
        run: npm run validate:content

      - name: Summary
        if: always()
        run: |
          echo "### ‚úÖ Content Validation" >> $GITHUB_STEP_SUMMARY
          echo "Markdown/MDX files validated for structure and frontmatter." >> $GITHUB_STEP_SUMMARY

  botid-validation:
    needs: setup
    name: BotID Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Validate BotID setup
        run: npm run validate:botid

      - name: Summary
        if: always()
        run: |
          echo "### ‚úÖ BotID Validation" >> $GITHUB_STEP_SUMMARY
          echo "Vercel protection bypass configuration validated." >> $GITHUB_STEP_SUMMARY

  dependabot-validation:
    needs: setup
    name: Dependabot Config Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Validate Dependabot configuration
        run: |
          # Check if dependabot.yml exists
          if [ ! -f .github/dependabot.yml ]; then
            echo "‚ùå .github/dependabot.yml not found"
            exit 1
          fi

          # Validate YAML syntax
          if ! python3 -c "import yaml; yaml.safe_load(open('.github/dependabot.yml'))" 2>/dev/null; then
            echo "‚ùå Invalid YAML syntax in dependabot.yml"
            exit 1
          fi

          echo "‚úÖ Dependabot configuration is valid"

      - name: Check for group overlap
        run: |
          # Check for package overlap between groups
          if [ -f scripts/validation/check-dependabot-groups.mjs ]; then
            node scripts/validation/check-dependabot-groups.mjs
          else
            echo "‚ÑπÔ∏è Dependabot group checker not found, skipping"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### ‚úÖ Dependabot Validation" >> $GITHUB_STEP_SUMMARY
          echo "Dependabot configuration validated for syntax and group overlap." >> $GITHUB_STEP_SUMMARY

  allowlist-validation:
    needs: setup
    name: Allowlist Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Validate PII allowlist
        run: npm run validate:allowlist

      - name: Audit allowlist usage
        run: npm run audit:allowlist
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "### ‚úÖ Allowlist Validation" >> $GITHUB_STEP_SUMMARY
          echo "PII allowlist validated for structure and usage." >> $GITHUB_STEP_SUMMARY

  changelog-validation:
    needs: setup
    name: Changelog Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Validate changelog format
        run: npm run changelog:validate

      - name: Check changelog sync status
        run: npm run changelog:check
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "### üìù Changelog Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Format: CalVer ([YYYY.MM.DD]) ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- Sync: Checked for staleness (>7 days)" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Soft warnings (non-blocking)" >> $GITHUB_STEP_SUMMARY

  version-validation:
    needs: setup
    name: Version Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Check version matches CalVer
        id: calver
        run: |
          EXPECTED=$(date -u +%Y.%m.%d)
          ACTUAL=$(node -p "require('./package.json').version")

          echo "Current version: $ACTUAL"
          echo "Expected (today): $EXPECTED"

          # Compare dates (version should not be in the future)
          ACTUAL_DATE=$(echo $ACTUAL | tr '.' '-')
          EXPECTED_DATE=$(echo $EXPECTED | tr '.' '-')

          if [[ "$ACTUAL_DATE" > "$EXPECTED_DATE" ]]; then
            echo "::error::Version $ACTUAL is in the future (expected max: $EXPECTED)"
            exit 1
          fi

          # Warn if version is more than 7 days old
          ACTUAL_TIMESTAMP=$(date -j -f "%Y-%m-%d" "$ACTUAL_DATE" +%s 2>/dev/null || echo 0)
          EXPECTED_TIMESTAMP=$(date -j -f "%Y-%m-%d" "$EXPECTED_DATE" +%s 2>/dev/null || date +%s)
          DIFF_DAYS=$(( ($EXPECTED_TIMESTAMP - $ACTUAL_TIMESTAMP) / 86400 ))

          if [ $DIFF_DAYS -gt 7 ]; then
            echo "::warning::Version $ACTUAL is $DIFF_DAYS days old (expected <7 days for CalVer)"
          fi

          echo "‚úÖ Version $ACTUAL is valid"

      - name: Validate CalVer format
        run: |
          VERSION=$(node -p "require('./package.json').version")

          # Check format: YYYY.MM.DD or YYYY.MM.DD.N
          if [[ ! "$VERSION" =~ ^[0-9]{4}\.[0-9]{2}\.[0-9]{2}(\.[0-9]+)?$ ]]; then
            echo "::error::Version $VERSION does not match CalVer format (YYYY.MM.DD or YYYY.MM.DD.N)"
            exit 1
          fi

          echo "‚úÖ Version $VERSION matches CalVer format"

      - name: Summary
        if: always()
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "### üìÖ Version Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Current version: **$VERSION**" >> $GITHUB_STEP_SUMMARY
          echo "- Format: CalVer (YYYY.MM.DD) ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-update: Configured (.github/workflows/auto-calver.yml)" >> $GITHUB_STEP_SUMMARY

  # Unified summary
  summary:
    needs: [content-validation, botid-validation, dependabot-validation, allowlist-validation, changelog-validation, version-validation]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate unified summary
        run: |
          echo "# ‚úÖ Validation Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.content-validation.result }}" == "success" ]; then
            echo "| Content (Markdown/MDX) | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Content (Markdown/MDX) | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.botid-validation.result }}" == "success" ]; then
            echo "| BotID Setup | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| BotID Setup | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.dependabot-validation.result }}" == "success" ]; then
            echo "| Dependabot Config | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Dependabot Config | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.allowlist-validation.result }}" == "success" ]; then
            echo "| PII Allowlist | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| PII Allowlist | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.changelog-validation.result }}" == "success" ]; then
            echo "| Changelog Validation | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Changelog Validation | ‚ö†Ô∏è Warning |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.version-validation.result }}" == "success" ]; then
            echo "| Version Validation | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Version Validation | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All validation checks completed." >> $GITHUB_STEP_SUMMARY

      - name: Fail if any validation failed
        if: |
          needs.content-validation.result == 'failure' ||
          needs.botid-validation.result == 'failure' ||
          needs.dependabot-validation.result == 'failure' ||
          needs.allowlist-validation.result == 'failure' ||
          needs.version-validation.result == 'failure'
        run: |
          echo "‚ùå One or more validations failed"
          exit 1
