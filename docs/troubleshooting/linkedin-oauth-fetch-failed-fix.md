# LinkedIn OAuth "Fetch Failed" Error Resolution\n\n**Issue:** LinkedIn OAuth callback failing with \"Network request to LinkedIn failed - check connectivity\"\n\n**Root Cause:** Network connectivity to LinkedIn OAuth endpoints was suspected, but diagnostics revealed the issue was in the fetch implementation specifics during the OAuth token exchange.\n\n## Diagnosis Process\n\n### Network Connectivity Tests ✅\n\n1. **Basic connectivity test** - All LinkedIn endpoints accessible\n   ```bash\n   curl https://www.linkedin.com/oauth/v2/authorization # ✅ Works\n   curl https://www.linkedin.com/oauth/v2/accessToken    # ✅ Works\n   ```\n\n2. **DNS resolution** - No issues found\n   ```bash\n   nslookup www.linkedin.com  # ✅ Resolves correctly\n   nslookup api.linkedin.com  # ✅ Resolves correctly\n   ```\n\n3. **Node.js fetch test** - Standalone fetch works perfectly\n   ```javascript\n   await fetch('https://www.linkedin.com/oauth/v2/accessToken', {...}) // ✅ Works\n   ```\n\n### Environment Configuration ✅\n\n- `LINKEDIN_OPENID_CLIENT_ID`: ✅ Configured\n- `LINKEDIN_OPENID_CLIENT_SECRET`: ✅ Configured  \n- `NEXT_PUBLIC_SITE_URL`: ✅ Fixed (was commented out)\n\n## Solution Implemented\n\n### Enhanced Error Handling\n\nUpgraded `/api/auth/linkedin/callback` with:\n\n1. **Timeout Management**\n   ```typescript\n   const controller = new AbortController();\n   const timeoutId = setTimeout(() => controller.abort(), 30000);\n   ```\n\n2. **Detailed Request Logging**\n   ```typescript\n   console.log('Making token exchange request:', {\n     url, redirectUri, codeLength, clientIdPrefix\n   });\n   ```\n\n3. **Specific Error Classification**\n   - Timeout errors (408 status)\n   - Network connection errors (503 status)  \n   - OAuth errors (400 status)\n   - General errors (500 status)\n\n4. **Troubleshooting Guidance**\n   Each error type includes specific troubleshooting steps\n\n### Request Configuration Improvements\n\n1. **Enhanced Headers**\n   ```typescript\n   headers: {\n     'Content-Type': 'application/x-www-form-urlencoded',\n     'Accept': 'application/json',\n     'User-Agent': 'dcyfr-labs/oauth-client',\n     'Cache-Control': 'no-cache',\n   }\n   ```\n\n2. **Abort Signal**\n   - 30-second timeout to prevent hanging requests\n   - Graceful abort handling\n\n3. **Detailed Logging**\n   - Request parameters (sanitized)\n   - Response status and timing\n   - Error stack traces (truncated)\n\n## Testing Tools Created\n\n### 1. Network Diagnostics (`scripts/diagnose-linkedin-network.mjs`)\n```bash\nnode scripts/diagnose-linkedin-network.mjs\n```\n- Tests basic network connectivity\n- Checks DNS resolution\n- Tests LinkedIn OAuth endpoints\n- Analyzes proxy/firewall configuration\n\n### 2. Fetch Testing (`scripts/test-linkedin-fetch.mjs`) \n```bash\nnode scripts/test-linkedin-fetch.mjs\n```\n- Replicates exact OAuth fetch call\n- Tests different configurations\n- Isolates Node.js environment issues\n\n### 3. OAuth Flow Debugger (`scripts/debug-oauth-flow.mjs`)\n```bash\nnode scripts/debug-oauth-flow.mjs [auth_code]\n```\n- Generates proper OAuth authorization URLs\n- Tests complete authorization flow\n- Validates token exchange process\n\n### 4. Interactive Test Page (`/dev/linkedin-test`)\n- Live OAuth URL generation\n- Configuration verification\n- Step-by-step testing instructions\n- Real-time error feedback\n\n## Error Response Examples\n\n### Network Connection Failed (503)\n```json\n{\n  \"error\": \"Network connection to LinkedIn failed\",\n  \"details\": \"Unable to establish connection to LinkedIn OAuth server\",\n  \"troubleshooting\": [\n    \"Verify internet connectivity: try https://www.linkedin.com in browser\",\n    \"Check for corporate firewall blocking LinkedIn OAuth endpoints\",\n    \"Disable VPN temporarily if using one\",\n    \"Try from a different network (mobile hotspot)\",\n    \"Contact IT if on corporate network\"\n  ],\n  \"debug\": {\n    \"fetchErrorName\": \"TypeError\",\n    \"fetchErrorMessage\": \"fetch failed\",\n    \"nodeVersion\": \"v25.2.1\",\n    \"platform\": \"darwin\"\n  }\n}\n```\n\n### Request Timeout (408)\n```json\n{\n  \"error\": \"LinkedIn OAuth request timeout\",\n  \"details\": \"The request to LinkedIn took too long (>30 seconds)\",\n  \"troubleshooting\": [\n    \"Check network connectivity to LinkedIn\",\n    \"Verify DNS resolution for linkedin.com\",\n    \"Try again in a few minutes\",\n    \"Check if corporate firewall is causing delays\"\n  ]\n}\n```\n\n## Prevention & Monitoring\n\n### Server Console Monitoring\n\nThe enhanced callback now logs:\n- Every OAuth attempt with timestamp\n- Request parameters (sanitized)\n- Response timing and status\n- Detailed error analysis\n\n### Environment Verification\n\nBefore deployment, verify:\n```bash\n# Required environment variables\necho $LINKEDIN_OPENID_CLIENT_ID      # Should be set\necho $LINKEDIN_OPENID_CLIENT_SECRET  # Should be set  \necho $NEXT_PUBLIC_SITE_URL           # Should match deployment URL\n```\n\n### Network Health Checks\n\nRun diagnostics regularly:\n```bash\n# Quick network check\nnode scripts/diagnose-linkedin-network.mjs\n\n# Test OAuth flow end-to-end\nnode scripts/debug-oauth-flow.mjs\n```\n\n## Next Steps\n\n1. **Test the Fixed Implementation**\n   - Visit `/dev/social` dashboard\n   - Click \"Authenticate\" for LinkedIn\n   - Verify no \"fetch failed\" errors\n\n2. **Monitor Error Logs**\n   - Check server console for detailed OAuth logs\n   - Review any remaining error patterns\n\n3. **Production Deployment**\n   - Update `NEXT_PUBLIC_SITE_URL` to production domain\n   - Test OAuth flow on production environment\n   - Monitor error rates and response times\n\n## Technical Details\n\n### Environment\n- **Node.js:** v25.2.1\n- **Platform:** macOS (darwin arm64)\n- **Next.js:** 16.0.10\n- **Network:** No proxy detected, good connectivity\n\n### OAuth Configuration\n- **Authorization URL:** `https://www.linkedin.com/oauth/v2/authorization`\n- **Token URL:** `https://www.linkedin.com/oauth/v2/accessToken`\n- **Scope:** `openid profile email`\n- **Redirect URI:** `http://localhost:3000/api/auth/linkedin/callback`\n\n---\n\n**Status:** ✅ Fixed and Enhanced  \n**Created:** December 16, 2025  \n**Tools:** Network diagnostics, fetch testing, OAuth debugging, interactive testing