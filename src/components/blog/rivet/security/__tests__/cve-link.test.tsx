import { render, screen } from "@testing-library/react";
import { describe, it, expect, beforeEach } from "vitest";
import { CVETracker, CVELink, CVEFootnote } from "../cve-link";

describe("CVELink", () => {
  describe("Basic Rendering", () => {
    it("renders CVE link without context (no footnote)", () => {
      render(<CVELink cve="CVE-2025-55131" />);
      const link = screen.getByText("CVE-2025-55131");
      expect(link).toBeInTheDocument();
      expect(link).toHaveAttribute(
        "href",
        "https://nvd.nist.gov/vuln/detail/CVE-2025-55131"
      );
    });

    it("renders CVE link with external link attributes", () => {
      render(<CVELink cve="CVE-2025-55131" />);
      const link = screen.getByText("CVE-2025-55131");
      expect(link).toHaveAttribute("target", "_blank");
      expect(link).toHaveAttribute("rel", "noopener noreferrer");
    });

    it("renders with aria-label for accessibility", () => {
      render(<CVELink cve="CVE-2025-55131" />);
      const link = screen.getByLabelText(
        "CVE-2025-55131 - View on NIST National Vulnerability Database"
      );
      expect(link).toBeInTheDocument();
    });

    it("applies monospace font styling", () => {
      render(<CVELink cve="CVE-2025-55131" />);
      const link = screen.getByText("CVE-2025-55131");
      expect(link).toHaveClass("font-mono");
    });
  });

  describe("CVE Format Validation", () => {
    it("parses valid CVE format (4-digit year)", () => {
      render(<CVELink cve="CVE-2025-12345" />);
      const link = screen.getByText("CVE-2025-12345");
      expect(link).toHaveAttribute(
        "href",
        "https://nvd.nist.gov/vuln/detail/CVE-2025-12345"
      );
    });

    it("handles CVE with lowercase format", () => {
      render(<CVELink cve="cve-2024-98765" />);
      const link = screen.getByText("cve-2024-98765");
      expect(link).toHaveAttribute(
        "href",
        "https://nvd.nist.gov/vuln/detail/CVE-2024-98765"
      );
    });

    it("handles invalid CVE format gracefully", () => {
      const consoleWarnSpy = vi.spyOn(console, "warn").mockImplementation(() => {});
      render(<CVELink cve="INVALID-CVE" />);
      
      // Should render plain text instead of link
      const text = screen.getByText("INVALID-CVE");
      expect(text).toBeInTheDocument();
      expect(text.tagName).toBe("SPAN");
      expect(consoleWarnSpy).toHaveBeenCalledWith("Invalid CVE format: INVALID-CVE");
      
      consoleWarnSpy.mockRestore();
    });

    it("handles CVE with 5-digit ID", () => {
      render(<CVELink cve="CVE-2025-100000" />);
      const link = screen.getByText("CVE-2025-100000");
      expect(link).toHaveAttribute(
        "href",
        "https://nvd.nist.gov/vuln/detail/CVE-2025-100000"
      );
    });
  });

  describe("First Mention Tracking with CVETracker", () => {
    it("displays footnote marker on first mention", () => {
      render(
        <CVETracker>
          <CVELink cve="CVE-2025-55131" />
        </CVETracker>
      );

      // Should have footnote marker (ArrowUpLeft icon)
      const footnoteLink = screen.getByLabelText("Jump to CVE details");
      expect(footnoteLink).toBeInTheDocument();
      expect(footnoteLink).toHaveAttribute("href", "#cve-2025-55131");
    });

    it("hides footnote marker on second mention", () => {
      render(
        <CVETracker>
          <div>
            <CVELink cve="CVE-2025-55131" />
            <CVELink cve="CVE-2025-55131" />
          </div>
        </CVETracker>
      );

      // Only one footnote marker should exist (first mention)
      const footnoteLinks = screen.queryAllByLabelText("Jump to CVE details");
      expect(footnoteLinks).toHaveLength(1);
    });

    it("tracks different CVEs independently", () => {
      render(
        <CVETracker>
          <div>
            <CVELink cve="CVE-2025-55131" />
            <CVELink cve="CVE-2025-55132" />
            <CVELink cve="CVE-2025-55131" />
          </div>
        </CVETracker>
      );

      // Both first mentions should have footnote markers
      const footnoteLinks = screen.queryAllByLabelText("Jump to CVE details");
      expect(footnoteLinks).toHaveLength(2);
    });
  });

  describe("Force Footnote", () => {
    it("displays footnote when forceFootnote is true", () => {
      render(
        <CVETracker>
          <div>
            <CVELink cve="CVE-2025-55131" />
            <CVELink cve="CVE-2025-55131" forceFootnote />
          </div>
        </CVETracker>
      );

      // Both should have footnote markers
      const footnoteLinks = screen.queryAllByLabelText("Jump to CVE details");
      expect(footnoteLinks).toHaveLength(2);
    });
  });

  describe("Custom Styling", () => {
    it("accepts custom className", () => {
      const { container } = render(
        <CVELink cve="CVE-2025-55131" className="custom-class" />
      );
      const wrapper = container.querySelector(".custom-class");
      expect(wrapper).toBeInTheDocument();
    });
  });

  describe("Footnote ID Generation", () => {
    it("generates correct footnote ID format", () => {
      render(
        <CVETracker>
          <CVELink cve="CVE-2025-55131" />
        </CVETracker>
      );

      const footnoteLink = screen.getByLabelText("Jump to CVE details");
      expect(footnoteLink).toHaveAttribute("href", "#cve-2025-55131");
    });

    it("generates unique IDs for different CVEs", () => {
      render(
        <CVETracker>
          <div>
            <CVELink cve="CVE-2025-55131" />
            <CVELink cve="CVE-2024-12345" />
          </div>
        </CVETracker>
      );

      const footnoteLinks = screen.queryAllByLabelText("Jump to CVE details");
      expect(footnoteLinks[0]).toHaveAttribute("href", "#cve-2025-55131");
      expect(footnoteLinks[1]).toHaveAttribute("href", "#cve-2024-12345");
    });
  });
});

describe("CVEFootnote", () => {
  describe("Rendering", () => {
    it("renders CVE footnote with description", () => {
      render(
        <CVEFootnote
          cve="CVE-2025-55131"
          description="Critical vulnerability in Node.js HTTP server"
        />
      );

      const link = screen.getByText("CVE-2025-55131");
      expect(link).toBeInTheDocument();
      
      const description = screen.getByText("Critical vulnerability in Node.js HTTP server");
      expect(description).toBeInTheDocument();
    });

    it("links to NVD database", () => {
      render(
        <CVEFootnote
          cve="CVE-2025-55131"
          description="Test vulnerability"
        />
      );

      const link = screen.getByText("CVE-2025-55131");
      expect(link).toHaveAttribute(
        "href",
        "https://nvd.nist.gov/vuln/detail/CVE-2025-55131"
      );
      expect(link).toHaveAttribute("target", "_blank");
    });

    it("displays CVSS score when provided", () => {
      render(
        <CVEFootnote
          cve="CVE-2025-55131"
          description="Test vulnerability"
          cvssScore={9.8}
        />
      );

      const score = screen.getByText("CVSS 9.8");
      expect(score).toBeInTheDocument();
    });

    it("displays severity when provided", () => {
      render(
        <CVEFootnote
          cve="CVE-2025-55131"
          description="Test vulnerability"
          severity="CRITICAL"
        />
      );

      const severity = screen.getByText("CRITICAL");
      expect(severity).toBeInTheDocument();
    });

    it("displays both CVSS and severity", () => {
      render(
        <CVEFootnote
          cve="CVE-2025-55131"
          description="Test vulnerability"
          cvssScore={7.5}
          severity="HIGH"
        />
      );

      expect(screen.getByText("CVSS 7.5")).toBeInTheDocument();
      expect(screen.getByText("HIGH")).toBeInTheDocument();
    });

    it("has correct ID for anchor linking", () => {
      const { container } = render(
        <CVEFootnote
          cve="CVE-2025-55131"
          description="Test vulnerability"
        />
      );

      const footnote = container.querySelector("#cve-2025-55131");
      expect(footnote).toBeInTheDocument();
    });
  });

  describe("Invalid CVE Format", () => {
    it("returns null for invalid CVE format", () => {
      const { container } = render(
        <CVEFootnote
          cve="INVALID-CVE"
          description="Test vulnerability"
        />
      );

      expect(container.firstChild).toBeNull();
    });
  });

  describe("Custom Styling", () => {
    it("accepts custom className", () => {
      const { container } = render(
        <CVEFootnote
          cve="CVE-2025-55131"
          description="Test vulnerability"
          className="custom-footnote"
        />
      );

      const footnote = container.querySelector(".custom-footnote");
      expect(footnote).toBeInTheDocument();
    });
  });

  describe("Severity Capitalization", () => {
    it("displays severity in uppercase", () => {
      render(
        <CVEFootnote
          cve="CVE-2025-55131"
          description="Test vulnerability"
          severity="medium"
        />
      );

      const severity = screen.getByText("medium");
      expect(severity).toHaveClass("uppercase");
    });
  });
});

describe("CVETracker Context", () => {
  it("provides tracking context to child components", () => {
    render(
      <CVETracker>
        <CVELink cve="CVE-2025-55131" />
      </CVETracker>
    );

    // Should have footnote marker (context is working)
    const footnoteLink = screen.getByLabelText("Jump to CVE details");
    expect(footnoteLink).toBeInTheDocument();
  });

  it("handles multiple CVETracker instances independently", () => {
    render(
      <>
        <CVETracker>
          <CVELink cve="CVE-2025-55131" />
          <CVELink cve="CVE-2025-55131" />
        </CVETracker>
        <CVETracker>
          <CVELink cve="CVE-2025-55131" />
        </CVETracker>
      </>
    );

    // Each tracker instance tracks separately
    // First tracker: 1 footnote (first mention only)
    // Second tracker: 1 footnote (first mention in new context)
    const footnoteLinks = screen.queryAllByLabelText("Jump to CVE details");
    expect(footnoteLinks).toHaveLength(2);
  });
});
