"use client";

import React, { createContext, useContext, useRef } from "react";
import { cn } from "@/lib/utils";
import { ANIMATION } from "@/lib/design-tokens";
import { ArrowUpLeft } from "lucide-react";

/**
 * CVELink - Automatic CVE linking with footnote tracking
 *
 * Features:
 * - Auto-links CVE IDs to NIST NVD database
 * - Tracks first mention for footnote generation
 * - Subsequent mentions link without footnote
 * - Theme-aware styling
 *
 * @example
 * ```tsx
 * <CVETracker>
 *   <p>This vulnerability (<CVELink cve="CVE-2025-55131" />) affects Node.js.</p>
 *   <p>The same <CVELink cve="CVE-2025-55131" /> was patched in v22.12.0.</p>
 * </CVETracker>
 * ```
 *
 * First mention: CVE-2025-55131[^1] (with footnote)
 * Second mention: CVE-2025-55131 (no footnote)
 */

interface CVETrackerContextValue {
  trackCVE: (cve: string) => boolean;
}

const CVETrackerContext = createContext<CVETrackerContextValue | null>(null);

interface CVETrackerProps {
  children: React.ReactNode;
}

/**
 * CVETracker - Context provider for tracking CVE mentions
 *
 * Wrap your blog content with this provider to enable
 * automatic first-mention tracking across CVE links.
 * Uses ref to avoid state updates during render.
 */
export function CVETracker({ children }: CVETrackerProps) {
  const mentionedCVEsRef = useRef<Set<string>>(new Set());

  const trackCVE = (cve: string): boolean => {
    const isFirst = !mentionedCVEsRef.current.has(cve);
    if (isFirst) {
      mentionedCVEsRef.current.add(cve);
    }
    return isFirst;
  };

  return (
    <CVETrackerContext.Provider value={{ trackCVE }}>
      {children}
    </CVETrackerContext.Provider>
  );
}

interface CVELinkProps {
  /** CVE identifier (e.g., "CVE-2025-55131") */
  cve: string;
  /** Optional className for custom styling */
  className?: string;
  /** Force footnote display (overrides first-mention tracking) */
  forceFootnote?: boolean;
}

/**
 * CVELink - Individual CVE link component
 *
 * Automatically generates NVD links and tracks first mentions.
 * Must be used within CVETracker context.
 */
export function CVELink({ cve, className, forceFootnote }: CVELinkProps) {
  const context = useContext(CVETrackerContext);

  // Parse CVE ID to extract year and ID for URL construction
  const match = cve.match(/CVE-(\d{4})-(\d+)/i);
  if (!match) {
    console.warn(`Invalid CVE format: ${cve}`);
    return <span className="text-muted-foreground">{cve}</span>;
  }

  const [year, id] = [match[1], match[2]];
  const nvdUrl = `https://nvd.nist.gov/vuln/detail/CVE-${year}-${id}`;

  // Track first mention (if context available)
  // Using ref-based tracking means this is safe to call during render
  const isFirst = forceFootnote || (context ? context.trackCVE(cve) : false);

  // Generate footnote ID based on CVE
  const footnoteId = `cve-${year}-${id}`;

  return (
    <span className={cn("inline-flex items-center gap-0.5", className)}>
      <a
        href={nvdUrl}
        target="_blank"
        rel="noopener noreferrer"
        className={cn(
          "font-mono text-sm",
          "text-primary dark:text-primary",
          "underline decoration-primary/40 decoration-dotted underline-offset-4",
          "hover:decoration-primary/70 hover:decoration-2",
          ANIMATION.transition.colors
        )}
        aria-label={`${cve} - View on NIST National Vulnerability Database`}
      >
        {cve}
      </a>
      {isFirst && (
        <sup className="ml-0.5 inline-flex items-center">
          <a
            href={`#${footnoteId}`}
            className="no-underline hover:opacity-70 transition-opacity"
            aria-label="Jump to CVE details"
          >
            <ArrowUpLeft className="inline-block w-3 h-3 text-primary" />
          </a>
        </sup>
      )}
    </span>
  );
}

/**
 * CVEFootnote - Individual footnote entry for CVE details
 *
 * Used in the footnotes section to provide additional context
 * about CVEs mentioned in the blog post.
 */
interface CVEFootnoteProps {
  /** CVE identifier */
  cve: string;
  /** Description of the vulnerability */
  description: string;
  /** Optional CVSS score */
  cvssScore?: number;
  /** Optional severity level */
  severity?: string;
  /** Optional className */
  className?: string;
}

export function CVEFootnote({
  cve,
  description,
  cvssScore,
  severity,
  className,
}: CVEFootnoteProps) {
  const match = cve.match(/CVE-(\d{4})-(\d+)/i);
  if (!match) return null;

  const [year, id] = [match[1], match[2]];
  const footnoteId = `cve-${year}-${id}`;
  const nvdUrl = `https://nvd.nist.gov/vuln/detail/CVE-${year}-${id}`;

  return (
    <div id={footnoteId} className={cn("space-y-1", className)}>
      <div className="flex items-center gap-2">
        <a
          href={nvdUrl}
          target="_blank"
          rel="noopener noreferrer"
          className="font-mono text-sm text-primary hover:underline"
        >
          {cve}
        </a>
        {cvssScore && (
          <span className="text-xs text-muted-foreground">
            CVSS {cvssScore}
          </span>
        )}
        {severity && (
          <span className="text-xs text-muted-foreground uppercase">
            {severity}
          </span>
        )}
      </div>
      <p className="text-sm text-muted-foreground leading-relaxed">
        {description}
      </p>
    </div>
  );
}
