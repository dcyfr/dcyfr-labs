name: Automated Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '!CHANGELOG.md'
  workflow_dispatch:
    inputs:
      force_micro:
        description: 'Force MICRO increment'
        required: false
        type: boolean

concurrency:
  group: release-${{ github.sha }}
  cancel-in-progress: false  # Never cancel releases

permissions:
  contents: write  # For tags, releases, commits
  pull-requests: read  # For PR data

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Only run on PR merges (not direct pushes or release commits)
    if: |
      github.event_name == 'push' &&
      contains(github.event.head_commit.message, 'Merge pull request') &&
      !startsWith(github.event.head_commit.message, 'chore(release):')

    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      release_url: ${{ steps.create_release.outputs.url }}
      skipped: ${{ steps.pr.outputs.skip }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      # STEP 1: Extract PR number from merge commit
      - name: Extract PR number
        id: pr
        run: |
          PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -oP 'Merge pull request #\K\d+' || echo "")

          if [ -z "$PR_NUMBER" ]; then
            echo "âš ï¸  Not a PR merge commit, skipping release"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "âœ… Detected PR #$PR_NUMBER"

      # STEP 2: Bump version with MICRO handling
      - name: Bump CalVer version
        if: steps.pr.outputs.skip != 'true'
        id: version
        run: |
          NEW_VERSION=$(node scripts/release/bump-version.mjs)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ New version: $NEW_VERSION"

      # STEP 3: Generate changelog entry
      - name: Generate changelog entry
        if: steps.pr.outputs.skip != 'true'
        id: changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        run: |
          node scripts/release/generate-changelog-entry.mjs \
            --pr=$PR_NUMBER \
            --version=${{ steps.version.outputs.new_version }} \
            > /tmp/changelog-entry.md

          echo "ðŸ“ Changelog entry generated:"
          cat /tmp/changelog-entry.md

      # STEP 4: Update CHANGELOG.md
      - name: Update CHANGELOG.md
        if: steps.pr.outputs.skip != 'true'
        run: |
          node scripts/release/update-changelog.mjs \
            --version=${{ steps.version.outputs.new_version }} \
            --entry=/tmp/changelog-entry.md

          echo "âœ… CHANGELOG.md updated"

      # STEP 5: Commit version bump + changelog
      - name: Commit release changes
        if: steps.pr.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json package-lock.json CHANGELOG.md
          git commit -m "chore(release): ${{ steps.version.outputs.new_version }}"
          git push origin main

          echo "âœ… Release commit pushed"

      # STEP 6: Create git tag
      - name: Create git tag
        if: steps.pr.outputs.skip != 'true'
        run: |
          git tag ${{ steps.version.outputs.new_version }}
          git push origin ${{ steps.version.outputs.new_version }}

          echo "âœ… Tag created: ${{ steps.version.outputs.new_version }}"

      # STEP 7: Generate release notes
      - name: Generate release notes
        if: steps.pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        run: |
          node scripts/release/create-release-notes.mjs \
            --pr=$PR_NUMBER \
            --version=${{ steps.version.outputs.new_version }} \
            --changelog=/tmp/changelog-entry.md \
            > /tmp/release-notes.md

          echo "ðŸ“¢ Release notes generated:"
          cat /tmp/release-notes.md

      # STEP 8: Create GitHub Release
      - name: Create GitHub Release
        if: steps.pr.outputs.skip != 'true'
        id: create_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_URL=$(gh release create ${{ steps.version.outputs.new_version }} \
            --title "Release ${{ steps.version.outputs.new_version }}" \
            --notes-file /tmp/release-notes.md \
            --target main \
            --verify-tag)

          echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "âœ… Release created: $RELEASE_URL"

      # STEP 9: Summary
      - name: Release summary
        if: steps.pr.outputs.skip != 'true'
        run: |
          echo "### ðŸš€ Release ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ steps.pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ steps.create_release.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next: Vercel deployment will trigger automatically" >> $GITHUB_STEP_SUMMARY
