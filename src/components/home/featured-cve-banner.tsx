import { Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { AlertTriangle, ExternalLink } from "lucide-react";
import Link from "next/link";
import { SPACING, ANIMATION } from "@/lib/design-tokens";
import { cn } from "@/lib/utils";

/**
 * FeaturedCVEBanner Component
 *
 * Displays critical CVE (Common Vulnerabilities and Exposures) alerts
 * prominently on the homepage. Fetches latest critical CVEs from NVD API.
 *
 * This is a unique differentiator for cybersecurity-focused content.
 *
 * Features:
 * - Real-time CVE data from National Vulnerability Database
 * - CVSS score display with severity badge
 * - Affected products list
 * - Direct link to full CVE details
 * - Animated entrance
 *
 * @component
 */

interface CVEData {
  id: string;
  title: string;
  cvssScore: number;
  severity: "critical" | "high" | "medium" | "low";
  affectedProducts: string[];
  publishedDate: string;
  description: string;
}

async function getLatestCriticalCVE(): Promise<CVEData | null> {
  try {
    // Calculate date range - last 21 days (balances recency with NVD API pagination limits)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 21);

    const startDateStr = startDate.toISOString().split('T')[0];
    const endDateStr = endDate.toISOString().split('T')[0];

    // Use CRITICAL severity filter to reduce results (then verify client-side)
    // NVD API returns 2500+ CVEs in 14 days, must filter server-side to avoid pagination
    const url = new URL("https://services.nvd.nist.gov/rest/json/cves/2.0");
    url.searchParams.set("pubStartDate", `${startDateStr}T00:00:00.000`);
    url.searchParams.set("pubEndDate", `${endDateStr}T23:59:59.999`);
    url.searchParams.set("cvssV3Severity", "CRITICAL"); // Reduces results significantly
    url.searchParams.set("resultsPerPage", "100");

    console.log(`[FeaturedCVE] Fetching CRITICAL CVEs from last 21 days...`);

    const response = await fetch(url.toString(), {
      next: { revalidate: 3600 }, // Cache for 1 hour
      headers: {
        "User-Agent": "DCYFR-Labs (https://dcyfr.dev)",
      },
    });

    if (!response.ok) {
      console.error(`[FeaturedCVE] NVD API request failed:`, response.statusText);
      return null;
    }

    const data = await response.json();

    if (!data.vulnerabilities || data.vulnerabilities.length === 0) {
      console.warn(`[FeaturedCVE] No CRITICAL CVEs found in last 21 days`);
      return null;
    }

    console.log(`[FeaturedCVE] Found ${data.vulnerabilities.length} CVEs, filtering for relevance...`);

    // Relevance keywords for DevSecOps, Web, AI, Cloud
    const relevantKeywords = [
      // Web Technologies
      'react', 'vue', 'angular', 'next.js', 'javascript', 'typescript', 'node.js', 'express',
      'django', 'flask', 'fastapi', 'ruby', 'rails', 'laravel', 'wordpress', 'drupal',
      // Cloud & Infrastructure
      'aws', 'azure', 'gcp', 'google cloud', 'kubernetes', 'docker', 'container', 'terraform',
      'cloudflare', 'vercel', 'nginx', 'apache', 'redis', 'postgresql', 'mysql', 'mongodb',
      // DevSecOps & Security Tools
      'jenkins', 'gitlab', 'github', 'circleci', 'oauth', 'jwt', 'saml', 'authentication',
      'authorization', 'api', 'rest', 'graphql', 'webhook', 'cors', 'xss', 'csrf', 'sql injection',
      // AI & Machine Learning
      'openai', 'anthropic', 'chatgpt', 'gpt', 'llm', 'langchain', 'pytorch', 'tensorflow',
      'machine learning', 'artificial intelligence', 'ai', 'ml', 'model', 'embedding',
      // Common Vulnerabilities
      'remote code execution', 'rce', 'privilege escalation', 'authentication bypass',
      'arbitrary file', 'path traversal', 'deserialization', 'injection', 'buffer overflow',
      // Programming Languages
      'python', 'java', 'go', 'rust', 'php', 'c#', '.net', 'dotnet',
    ];

    // Filter and score by relevance
    const scoredVulns = data.vulnerabilities
      .map((vuln: any) => {
        const cve = vuln.cve;
        const metrics = cve.metrics?.cvssMetricV31?.[0] || cve.metrics?.cvssMetricV2?.[0];
        const description = (cve.descriptions?.[0]?.value || '').toLowerCase();

        // Calculate relevance score
        let relevanceScore = 0;
        relevantKeywords.forEach(keyword => {
          if (description.includes(keyword)) {
            relevanceScore += 1;
          }
        });

        // Extract products for additional context
        const products = new Set<string>();
        cve.configurations?.forEach((config: any) => {
          config.nodes?.forEach((node: any) => {
            node.cpeMatch?.forEach((cpe: any) => {
              if (cpe.criteria) {
                const parts = cpe.criteria.split(":");
                if (parts.length >= 5 && parts[3] !== "*" && parts[4] !== "*") {
                  const vendor = parts[3].replace(/_/g, " ").toLowerCase();
                  const product = parts[4].replace(/_/g, " ").toLowerCase();
                  products.add(`${vendor} ${product}`);

                  // Boost relevance for well-known products
                  relevantKeywords.forEach(keyword => {
                    if (vendor.includes(keyword) || product.includes(keyword)) {
                      relevanceScore += 2; // Product names are more reliable
                    }
                  });
                }
              }
            });
          });
        });

        return {
          cve,
          score: metrics?.cvssData?.baseScore || 0,
          severity: metrics?.cvssData?.baseSeverity?.toLowerCase() || "unknown",
          published: new Date(cve.published),
          relevanceScore,
          products: Array.from(products),
        };
      })
      .filter((item: any) => {
        // Must meet minimum CVSS score (9.0+) AND have relevance
        return item.score >= 9.0 && item.relevanceScore > 0;
      })
      .sort((a: any, b: any) => {
        // Sort by CVSS score first (highest severity), then recency, then relevance
        if (b.score !== a.score) {
          return b.score - a.score;
        }
        if (b.published.getTime() !== a.published.getTime()) {
          return b.published.getTime() - a.published.getTime();
        }
        return b.relevanceScore - a.relevanceScore;
      });

    console.log(`[FeaturedCVE] After relevance filtering: ${scoredVulns.length} relevant CVEs (CVSS >= 9.0)`);

    if (scoredVulns.length === 0) {
      console.warn("[FeaturedCVE] No relevant CRITICAL CVEs found in last 21 days");
      return null;
    }

    // Get the most relevant CVE
    const { cve, score, severity: cveSeverity, relevanceScore, products: extractedProducts } = scoredVulns[0];

    console.log(
      `[FeaturedCVE] Selected: ${cve.id} (CVSS ${score}, ${cveSeverity}, relevance: ${relevanceScore})`
    );

    // Use already extracted products (with proper formatting)
    const products = extractedProducts.map((p: string) =>
      p.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
    );

    return {
      id: cve.id,
      title: cve.descriptions?.[0]?.value || "Critical Vulnerability Discovered",
      cvssScore: score,
      severity: cveSeverity as CVEData["severity"],
      affectedProducts: products.slice(0, 3),
      publishedDate: cve.published,
      description: cve.descriptions?.[0]?.value || "",
    };
  } catch (error) {
    console.error("[FeaturedCVE] Failed to fetch CVE data:", error);
    return null;
  }
}

export async function FeaturedCVEBanner() {
  const cve = await getLatestCriticalCVE();

  if (!cve) {
    return null;
  }

  return (
    <Card
      className={cn(
        "border-destructive/50 bg-destructive/5 dark:bg-destructive/10",
        ANIMATION.transition.base
      )}
    >
      <div className={cn("flex items-start gap-4 p-4 md:p-8", SPACING.compact)}>
        {/* Icon */}
        <div className="flex-shrink-0">
          <AlertTriangle className="h-6 w-6 text-destructive" />
        </div>

        {/* Content */}
        <div className="flex-1 min-w-0">
          {/* Header */}
          <div className="flex flex-wrap items-center gap-2 mb-2">
            <Badge variant="destructive" className="uppercase font-semibold">
              {cve.severity}
            </Badge>
            <span className="text-sm text-muted-foreground">
              {cve.id} â€¢ CVSS {cve.cvssScore}
            </span>
          </div>

          {/* Title */}
          <h3 className="font-semibold text-foreground mb-1 line-clamp-2">
            {cve.title}
          </h3>

          {/* Affected Products */}
          {cve.affectedProducts.length > 0 && (
            <p className="text-sm text-muted-foreground mb-3">
              <span className="font-medium">Affects:</span>{" "}
              {cve.affectedProducts.join(", ")}
              {cve.affectedProducts.length >= 3 && " and more"}
            </p>
          )}

          {/* Published Date */}
          <p className="text-xs text-muted-foreground">
            Published {new Date(cve.publishedDate).toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            })}
          </p>
        </div>

        {/* CTA */}
        <div className="flex-shrink-0">
          <Button variant="outline" size="sm" asChild>
            <Link
              href={`https://nvd.nist.gov/vuln/detail/${cve.id}`}
              target="_blank"
              rel="noopener noreferrer"
              className="gap-2"
            >
              View Details
              <ExternalLink className="h-3 w-3" />
            </Link>
          </Button>
        </div>
      </div>
    </Card>
  );
}
