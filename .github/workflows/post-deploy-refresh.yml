name: Post-Deploy Cache Refresh

# Trigger on successful Vercel deployments
on:
  deployment_status:

jobs:
  refresh-github-cache:
    name: Refresh GitHub Activity Cache
    # Only run on successful deployments
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest

    # Set a timeout to prevent hanging
    timeout-minutes: 5

    steps:
      - name: Determine deployment URL
        id: deployment
        run: |
          # Get the deployment URL from the event
          DEPLOY_URL="${{ github.event.deployment_status.target_url }}"

          # Extract the actual deployment domain from Vercel's URL
          # Vercel URLs are like: https://vercel.com/dcyfr/dcyfr-labs/123abc
          # We need to get the actual deployment URL from the environment
          DEPLOYMENT_URL="${{ github.event.deployment_status.environment_url }}"

          # Remove https:// or http:// prefix for display
          CLEAN_URL="${DEPLOYMENT_URL#https://}"
          CLEAN_URL="${CLEAN_URL#http://}"

          echo "deployment_url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT
          echo "clean_url=${CLEAN_URL}" >> $GITHUB_OUTPUT
          echo "environment=${{ github.event.deployment_status.environment }}" >> $GITHUB_OUTPUT

      - name: Log deployment info
        run: |
          echo "üöÄ Deployment Details:"
          echo "   Environment: ${{ steps.deployment.outputs.environment }}"
          echo "   URL: ${{ steps.deployment.outputs.clean_url }}"
          echo "   Commit: ${{ github.sha }}"

      - name: Wait for deployment to be fully ready
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment to stabilize..."
          sleep 30

      - name: Trigger GitHub cache refresh
        id: refresh
        env:
          DEPLOYMENT_URL: ${{ steps.deployment.outputs.deployment_url }}
          REFRESH_TOKEN: ${{ secrets.CACHE_REFRESH_TOKEN }}
        run: |
          echo "üîÑ Triggering cache refresh..."

          # Construct the API endpoint URL
          API_URL="${DEPLOYMENT_URL}/api/github/refresh"

          # Make the request with proper error handling
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
            -X POST "${API_URL}" \
            -H "Authorization: Bearer ${REFRESH_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"force": true}')

          echo "Response code: ${HTTP_CODE}"

          if [ "${HTTP_CODE}" -eq 200 ]; then
            echo "‚úÖ Cache refresh triggered successfully"
            cat response.json | jq '.'
            exit 0
          else
            echo "‚ö†Ô∏è  Cache refresh failed (HTTP ${HTTP_CODE})"
            cat response.json | jq '.' || cat response.json
            echo "Note: Deployment is still successful. Hourly cron will populate cache."
            exit 0  # Don't fail the workflow
          fi

      - name: Verify cache refresh (optional)
        if: success()
        env:
          DEPLOYMENT_URL: ${{ steps.deployment.outputs.deployment_url }}
        continue-on-error: true
        run: |
          echo "‚è≥ Waiting 60 seconds for Inngest to process..."
          sleep 60

          echo "üîç Checking cache status..."
          curl -s "${DEPLOYMENT_URL}/api/debug/redis-config" | jq '{
            environment: .detectedEnvironment,
            redisConfigured: (.hasProductionUrl or .hasPreviewUrl)
          }'

      - name: Summary
        if: always()
        run: |
          echo "üìä Post-Deploy Refresh Summary"
          echo "   Environment: ${{ steps.deployment.outputs.environment }}"
          echo "   Deployment: ${{ steps.deployment.outputs.clean_url }}"
          echo "   Status: Cache refresh initiated"
          echo ""
          echo "Next steps:"
          echo "   1. Check Inngest dashboard: https://app.inngest.com/"
          echo "   2. Verify GitHub Activity component displays real data"
          echo "   3. Check diagnostic endpoint: ${DEPLOYMENT_URL}/api/debug/redis-config"
