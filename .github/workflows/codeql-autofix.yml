name: CodeQL Autofix - Create Fix PRs

on:
  workflow_dispatch: # Manual trigger
    inputs:
      alert_number:
        description: 'CodeQL alert number (leave blank for all open alerts)'
        required: false
      severity:
        description: 'Minimum severity to fix (critical, high, medium, low, warning, note)'
        required: false
        default: 'high'
      dry_run:
        description: 'Dry run (no actual branch/PR creation)'
        required: false
        default: 'false'
  schedule:
    # Run daily at 07:00 UTC to auto-fix CodeQL alerts from previous day's scan
    - cron: '0 7 * * *'

# Only one fix run at a time
concurrency:
  group: codeql-autofix-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  security-events: read
  issues: read

jobs:
  analyze-alerts:
    name: Analyze CodeQL Alerts
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      alerts_json: ${{ steps.get-alerts.outputs.alerts_json }}
      alerts_count: ${{ steps.get-alerts.outputs.alerts_count }}
      has_fixable: ${{ steps.get-alerts.outputs.has_fixable }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: gh --version

      - name: Get CodeQL alerts
        id: get-alerts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ALERT_NUMBER: ${{ github.event.inputs.alert_number }}
          MIN_SEVERITY: ${{ github.event.inputs.severity }}
        run: |
          node scripts/ci/analyze-codeql-alerts.mjs

      - name: Output summary
        if: always()
        run: |
          echo "## CodeQL Alerts Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total alerts found:** ${{ steps.get-alerts.outputs.alerts_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Potentially fixable:** ${{ steps.get-alerts.outputs.has_fixable }}" >> $GITHUB_STEP_SUMMARY

  generate-fixes:
    name: Generate CodeQL Fixes with Copilot
    runs-on: ubuntu-latest
    needs: analyze-alerts
    if: needs.analyze-alerts.outputs.has_fixable == 'true'
    timeout-minutes: 30
    strategy:
      max-parallel: 1 # Process one alert at a time to manage rate limits
      matrix:
        include: ${{ fromJson(needs.analyze-alerts.outputs.alerts_json) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better context

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Setup GitHub CLI
        run: gh --version

      - name: Create feature branch
        id: create-branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ALERT_NUMBER: ${{ matrix.number }}
          RULE_ID: ${{ matrix.rule_id }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          node scripts/ci/create-codeql-fix-branch.mjs

      - name: Request GitHub Copilot fix
        id: copilot-fix
        if: steps.create-branch.outputs.branch_name != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BRANCH_NAME: ${{ steps.create-branch.outputs.branch_name }}
          ALERT_NUMBER: ${{ matrix.number }}
          RULE_ID: ${{ matrix.rule_id }}
          RULE_NAME: ${{ matrix.rule_name }}
          ALERT_FILE: ${{ matrix.file }}
          ALERT_LINE: ${{ matrix.line }}
          DESCRIPTION: ${{ matrix.description }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          node scripts/ci/request-copilot-fix.mjs

      - name: Validate fix
        if: steps.create-branch.outputs.branch_name != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.create-branch.outputs.branch_name }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          node scripts/ci/validate-security-fix.mjs

      - name: Create Pull Request
        id: create-pr
        if: steps.create-branch.outputs.branch_name != '' && steps.copilot-fix.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BRANCH_NAME: ${{ steps.create-branch.outputs.branch_name }}
          ALERT_NUMBER: ${{ matrix.number }}
          RULE_ID: ${{ matrix.rule_id }}
          RULE_NAME: ${{ matrix.rule_name }}
          ALERT_FILE: ${{ matrix.file }}
          ALERT_LINE: ${{ matrix.line }}
          DESCRIPTION: ${{ matrix.description }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          node scripts/ci/create-codeql-fix-pr.mjs

      - name: Request Copilot Review
        if: steps.create-pr.outputs.pr_number != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
        run: |
          gh pr review $PR_NUMBER --approve -b "âœ… Automated CodeQL fix PR - approved for review by GitHub Copilot"

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [analyze-alerts, generate-fixes]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CodeQL Autofix Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Alerts analyzed:** ${{ needs.analyze-alerts.outputs.alerts_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fixable alerts:** ${{ needs.analyze-alerts.outputs.has_fixable }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review generated PRs in [Pull Requests tab](https://github.com/${{ github.repository }}/pulls)" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify fixes don't break tests: \`npm run check\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Follow DCYFR security policies in [CODEQL_SUPPRESSIONS.md](.github/agents/patterns/CODEQL_SUPPRESSIONS.md)" >> $GITHUB_STEP_SUMMARY
