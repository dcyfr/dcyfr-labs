name: Sync Production Metrics

# Sync production analytics metrics to preview database
# Runs on schedule as backup/redundancy to build-time sync
# Also can be triggered manually for immediate sync

on:
  # Run daily at 2 AM UTC (off-peak hours)
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Sync mode (quick or full)'
        required: false
        default: 'full'
        type: choice
        options:
          - quick
          - full

jobs:
  sync-metrics:
    name: Sync Production Analytics
    runs-on: ubuntu-latest

    # Only run on main/preview branches or manual trigger
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/preview' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v1
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          UPSTASH_REDIS_REST_URL: op://CI-CD/dcyfr-labs-upstash-redis-rest-url/credential
          UPSTASH_REDIS_REST_TOKEN: op://Development/dcyfr-labs-upstash-redis-rest-token/credential
          UPSTASH_REDIS_REST_URL_PREVIEW: op://CI-CD/dcyfr-labs-upstash-redis-rest-url-preview/credential
          UPSTASH_REDIS_REST_TOKEN_PREVIEW: op://CI-CD/dcyfr-labs-upstash-redis-rest-token-preview/credential


      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.13.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run sync (quick mode)
        if: github.event.inputs.mode == 'quick' || github.event_name == 'schedule'
        env:
          UPSTASH_REDIS_REST_URL: $UPSTASH_REDIS_REST_URL
          UPSTASH_REDIS_REST_TOKEN: $UPSTASH_REDIS_REST_TOKEN
          UPSTASH_REDIS_REST_URL_PREVIEW: $UPSTASH_REDIS_REST_URL_PREVIEW
          UPSTASH_REDIS_REST_TOKEN_PREVIEW: $UPSTASH_REDIS_REST_TOKEN_PREVIEW
        run: npm run sync:metrics:quick

      - name: Run sync (full mode)
        if: github.event.inputs.mode == 'full' && github.event_name == 'workflow_dispatch'
        env:
          UPSTASH_REDIS_REST_URL: $UPSTASH_REDIS_REST_URL
          UPSTASH_REDIS_REST_TOKEN: $UPSTASH_REDIS_REST_TOKEN
          UPSTASH_REDIS_REST_URL_PREVIEW: $UPSTASH_REDIS_REST_URL_PREVIEW
          UPSTASH_REDIS_REST_TOKEN_PREVIEW: $UPSTASH_REDIS_REST_TOKEN_PREVIEW
        run: npm run sync:metrics

      - name: Report sync status
        if: success()
        run: |
          echo "✅ Metrics sync completed successfully"
          echo "Mode: ${{ github.event.inputs.mode || 'quick (scheduled)' }}"
          echo "Triggered by: ${{ github.event_name }}"

      - name: Report sync failure
        if: failure()
        run: |
          echo "❌ Metrics sync failed"
          echo "Check logs above for details"
          exit 1
