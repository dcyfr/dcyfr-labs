name: Validation Suite

# Consolidated validation workflow combining:
# - validate-content.yml (Markdown validation)
# - validate-botid.yml (BotID setup validation)
# - validate-dependabot.yml (Dependabot config validation)
#
# Optimized to share npm ci and run validations in parallel

on:
  pull_request:
    paths:
      - 'src/content/**/*.mdx'
      - 'docs/**/*.md'
      - '.github/dependabot.yml'
      - 'scripts/validation/**/*'
      - 'vercel.json'
  push:
    branches: [main, preview]
    paths:
      - 'src/content/**/*.mdx'
      - 'docs/**/*.md'
      - '.github/dependabot.yml'
  schedule:
    # Weekly validation on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

concurrency:
  group: validation-suite-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # Single setup job - install dependencies once
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Cache node_modules
        uses: actions/cache/save@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}

  # Validation jobs run in parallel
  content-validation:
    needs: setup
    name: Content Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Validate Markdown content
        run: npm run validate:content

      - name: Summary
        if: always()
        run: |
          echo "### ✅ Content Validation" >> $GITHUB_STEP_SUMMARY
          echo "Markdown/MDX files validated for structure and frontmatter." >> $GITHUB_STEP_SUMMARY

  botid-validation:
    needs: setup
    name: BotID Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Validate BotID setup
        run: npm run validate:botid

      - name: Summary
        if: always()
        run: |
          echo "### ✅ BotID Validation" >> $GITHUB_STEP_SUMMARY
          echo "Vercel protection bypass configuration validated." >> $GITHUB_STEP_SUMMARY

  dependabot-validation:
    needs: setup
    name: Dependabot Config Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Validate Dependabot configuration
        run: |
          # Check if dependabot.yml exists
          if [ ! -f .github/dependabot.yml ]; then
            echo "❌ .github/dependabot.yml not found"
            exit 1
          fi

          # Validate YAML syntax
          if ! python3 -c "import yaml; yaml.safe_load(open('.github/dependabot.yml'))" 2>/dev/null; then
            echo "❌ Invalid YAML syntax in dependabot.yml"
            exit 1
          fi

          echo "✅ Dependabot configuration is valid"

      - name: Check for group overlap
        run: |
          # Check for package overlap between groups
          if [ -f scripts/validation/check-dependabot-groups.mjs ]; then
            node scripts/validation/check-dependabot-groups.mjs
          else
            echo "ℹ️ Dependabot group checker not found, skipping"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### ✅ Dependabot Validation" >> $GITHUB_STEP_SUMMARY
          echo "Dependabot configuration validated for syntax and group overlap." >> $GITHUB_STEP_SUMMARY

  allowlist-validation:
    needs: setup
    name: Allowlist Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: validation-node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Validate PII allowlist
        run: npm run validate:allowlist

      - name: Audit allowlist usage
        run: npm run audit:allowlist
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "### ✅ Allowlist Validation" >> $GITHUB_STEP_SUMMARY
          echo "PII allowlist validated for structure and usage." >> $GITHUB_STEP_SUMMARY

  # Unified summary
  summary:
    needs: [content-validation, botid-validation, dependabot-validation, allowlist-validation]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate unified summary
        run: |
          echo "# ✅ Validation Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.content-validation.result }}" == "success" ]; then
            echo "| Content (Markdown/MDX) | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Content (Markdown/MDX) | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.botid-validation.result }}" == "success" ]; then
            echo "| BotID Setup | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| BotID Setup | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.dependabot-validation.result }}" == "success" ]; then
            echo "| Dependabot Config | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Dependabot Config | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.allowlist-validation.result }}" == "success" ]; then
            echo "| PII Allowlist | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| PII Allowlist | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All validation checks completed." >> $GITHUB_STEP_SUMMARY

      - name: Fail if any validation failed
        if: |
          needs.content-validation.result == 'failure' ||
          needs.botid-validation.result == 'failure' ||
          needs.dependabot-validation.result == 'failure' ||
          needs.allowlist-validation.result == 'failure'
        run: |
          echo "❌ One or more validations failed"
          exit 1
