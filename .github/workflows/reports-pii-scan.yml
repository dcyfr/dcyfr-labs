name: Reports PII Scan

on:
  pull_request:
    paths:
      - 'playwright-report/**'
      - 'reports/**'
      - 'coverage/**'
      - 'test-results/**'

concurrency:
  group: reports-pii-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  filter:
    runs-on: ubuntu-latest
    name: Check changed paths
    outputs:
      reports_changed: ${{ steps.changed.outputs.reports }}
    steps:
      - uses: actions/checkout@v4

      - name: Filter paths for reports
        id: changed
        uses: dorny/paths-filter@v3
        with:
          filters: |
            reports:
              - 'playwright-report/**'
              - 'reports/**'
              - 'coverage/**'
              - 'test-results/**'

  scan:
    needs: filter
    runs-on: ubuntu-latest
    if: needs.filter.outputs.reports_changed == 'true'
    name: Scan added/modified reports for PII
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Run reports PII scanner
        id: run-reports
        run: |
          npm run scan:reports > reports-scan-output.txt 2>&1 || SCAN_EXIT_CODE=$?
          echo "exit_code=${SCAN_EXIT_CODE:-0}" >> $GITHUB_OUTPUT
          if [ -f reports-scan-output.txt ]; then
            echo "report<<EOF" >> $GITHUB_OUTPUT
            cat reports-scan-output.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload scan output
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: reports-scan-output
          path: reports-scan-output.txt

      - name: Fail if PII found
        if: steps.run-reports.outputs.exit_code != '0'
        run: |
          echo "Potential PII detected in report artifacts. See attached reports-scan-output.txt" >&2
          exit 1

      - name: Post scan results to PR
        if: always() && (github.event_name == 'pull_request')
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### Reports PII Scanner Results
            This PR modifies or adds report artifacts (playwright/coverage/test-results). The repository ran a focused PII scan on those artifacts.

            **Scan Output:**
            ```
            ${{ steps.run-reports.outputs.report }}
            ```
