name: AI Instructions Sync & Validation

# Synchronize AI instructions and agents across all implementations
# Primary â†’ Secondary Model: Claude Code (primary) auto-syncs to Copilot (secondary)
on:
  workflow_dispatch:
  schedule:
    # Run on the 1st of every month at 9:00 UTC
    - cron: '0 9 1 * *'

jobs:
  sync-agents:
    runs-on: ubuntu-latest
    name: Sync AI Agents (Claude Code â†’ Copilot)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run agent sync
        run: npm run sync:agents
        continue-on-error: false

      - name: Check sync status
        run: npm run sync:agents -- --status
        if: always()

      - name: Generate monthly learning report
        run: npm run learning:report -- --month $(date +%Y-%m)
        continue-on-error: true

      - name: Commit sync changes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add sync reports
          git add sync-report-*.md || true

          # Add learning reports if they exist (not in git per data protection policy)
          # Reports are generated but not committed - stored as artifacts only

          if git diff --quiet --cached; then
            echo "No changes detected"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: sync DCYFR agents (primary â†’ secondary model)"
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        if: steps.commit.outputs.changes == 'true'
        with:
          commit-message: 'chore: sync DCYFR agents (Claude Code â†’ Copilot)'
          title: 'chore: monthly agent sync'
          body: |
            ## Monthly DCYFR Agent Synchronization

            This PR contains monthly synchronization of AI agents across implementations.

            **Sync Direction:** Claude Code (ðŸ”´ Primary) â†’ Copilot (ðŸŸ¡ Secondary)

            ### Changes
            - Updated Copilot quick reference from Claude Code patterns
            - Generated sync validation report
            - All implementations validated for consistency
            - Monthly learning report generated (available in artifacts)

            ### Artifacts
            - **Sync reports:** `agent-sync-reports` artifact
            - **Learning report:** `learning-report-${{ github.run_number }}` artifact (90-day retention)

            ### Strategy
            See [`docs/ai/AGENT_SYNC_STRATEGY.md`](./docs/ai/AGENT_SYNC_STRATEGY.md) for sync strategy and [`docs/ai/AGENT_UNIFICATION_ANALYSIS.md`](./docs/ai/AGENT_UNIFICATION_ANALYSIS.md) for rationale.

            **Automated by:** `ai-instructions-sync.yml` (monthly, 1st of month 9:00 UTC)
          branch: sync/agents-${{ github.run_number }}
          delete-branch: true

      - name: Publish sync report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: agent-sync-reports
          path: sync-report-*.md
          if-no-files-found: ignore
          retention-days: 30

      - name: Publish learning report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: learning-report-${{ github.run_number }}
          path: .github/agents/learning-data/monthly-reports/*.md
          if-no-files-found: ignore
          retention-days: 90

  validate:
    runs-on: ubuntu-latest
    name: Validate Instruction Files
    needs: sync-agents
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate instruction files
        run: |
          if [ -f scripts/validate-instructions.mjs ]; then
            node scripts/validate-instructions.mjs
          else
            echo "No validation script found, skipping..."
          fi
        continue-on-error: true

      - name: Check MCP servers
        run: |
          if [ -f scripts/check-mcp-servers.mjs ]; then
            node scripts/check-mcp-servers.mjs --no-auth || echo "MCP checks completed"
          else
            echo "No MCP script found, proceeding..."
          fi
        continue-on-error: true
