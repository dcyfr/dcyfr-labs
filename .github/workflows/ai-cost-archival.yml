name: AI Cost Archival

on:
  schedule:
    # Run daily at 00:00 UTC (midnight)
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  archive-costs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
       - name: Archive AI costs
         run: npm run ai:costs:archive
         env:
           # Production API endpoint
           API_URL: https://dcyfr-labs.vercel.app
           # Required for API access
           UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
           UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          
      - name: Commit archive files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Stage archive files
          git add .ai-costs-archive/
          
          # Commit only if there are changes
          if git diff --cached --quiet; then
            echo "No changes to archive"
          else
            git commit -m "chore: Archive AI cost data for $(date +'%Y-%m-%d')"
            git push
          fi
          
      - name: Clean up old archives
        run: |
          # The script automatically handles 90-day retention
          # Just re-run to ensure cleanup happens
          npm run ai:costs:archive
          
      - name: Generate archive report
        run: |
          echo "## AI Cost Archive Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count files
          DAILY_COUNT=$(find .ai-costs-archive/daily -name "*.json" 2>/dev/null | wc -l || echo "0")
          MONTHLY_COUNT=$(find .ai-costs-archive/monthly -name "*.json" 2>/dev/null | wc -l || echo "0")
          
          echo "**Archive Statistics:**" >> $GITHUB_STEP_SUMMARY
          echo "- Daily snapshots: $DAILY_COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "- Monthly summaries: $MONTHLY_COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get latest snapshot info
          if [ -f ".ai-costs-archive/daily/$(date +'%Y-%m-%d').json" ]; then
            TOTAL_COST=$(cat ".ai-costs-archive/daily/$(date +'%Y-%m-%d').json" | grep -o '"totalCost":[^,]*' | cut -d':' -f2 || echo "0")
            TOTAL_SESSIONS=$(cat ".ai-costs-archive/daily/$(date +'%Y-%m-%d').json" | grep -o '"totalSessions":[^,]*' | cut -d':' -f2 || echo "0")
            
            echo "**Latest Snapshot ($(date +'%Y-%m-%d')):**" >> $GITHUB_STEP_SUMMARY
            echo "- Total cost: \$$TOTAL_COST" >> $GITHUB_STEP_SUMMARY
            echo "- Total sessions: $TOTAL_SESSIONS" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::AI cost archival failed. Check logs for details."
