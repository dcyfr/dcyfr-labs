#!/bin/bash
# Pre-commit hook to warn about new LGTM suppressions
# Install: cp scripts/hooks/pre-commit.lgtm-check .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

# Check for new LGTM suppressions in staged files
NEW_LGTM=$(git diff --cached | grep -i "^\+.*lgtm \[" | grep -v ".github/agents/patterns/CODEQL_SUPPRESSIONS.md")

if [[ -n "$NEW_LGTM" ]]; then
  echo ""
  echo "âš ï¸  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "âš ï¸  WARNING: New LGTM suppression comment detected!"
  echo "âš ï¸  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  echo "ğŸ“‹ New suppression(s):"
  echo "$NEW_LGTM"
  echo ""
  echo "ğŸ”’ REQUIRED BEFORE COMMIT:"
  echo "   1. Spend 30+ minutes attempting to FIX the issue"
  echo "   2. Document fix attempts in commit message"
  echo "   3. Review: docs/security/LGTM_APPROVAL_PROCESS.md"
  echo ""
  echo "âœ… Fix examples:"
  echo "   - Input validation: /^[a-z0-9._-]+$/i"
  echo "   - Sanitization: remove control chars + ANSI codes"
  echo "   - Restructure: make security checks explicit"
  echo ""
  echo "ğŸ“š See: docs/security/private/CODEQL_FINDINGS_RESOLVED.md"
  echo ""

  # Interactive prompt
  read -p "â“ Have you completed fix attempts (30+ min)? (y/N) " -n 1 -r
  echo ""

  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    echo "âŒ Commit blocked - Please attempt fixes first"
    echo "   Required: minimum 30 minutes of fix attempts"
    echo "   See: docs/security/LGTM_APPROVAL_PROCESS.md"
    echo ""
    exit 1
  fi

  echo ""
  read -p "â“ Is this a confirmed false positive? (y/N) " -n 1 -r
  echo ""

  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    echo "âŒ Commit blocked - Real security issues must be fixed"
    echo "   Suppressions only for confirmed false positives"
    echo ""
    exit 1
  fi

  echo ""
  echo "âš ï¸  Proceeding with suppression (requires PR approval)"
  echo "   Don't forget to document fix attempts in commit message!"
  echo ""
fi

exit 0
