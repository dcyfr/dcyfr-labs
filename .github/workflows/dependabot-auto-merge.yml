name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      
      - name: Determine if safe to auto-merge
        id: check
        run: |
          echo "PR: ${{ github.event.pull_request.title }}"
          echo "Update type: ${{ steps.metadata.outputs.update-type }}"
          echo "Dependency type: ${{ steps.metadata.outputs.dependency-type }}"
          
          SAFE="false"
          REASON=""
          
          # Auto-merge dev dependencies (patch and minor updates)
          if [[ "${{ steps.metadata.outputs.dependency-type }}" == "direct:development" ]] || \
             [[ "${{ steps.metadata.outputs.dependency-type }}" == "indirect:development" ]]; then
            if [[ "${{ steps.metadata.outputs.update-type }}" == "version-update:semver-patch" ]] || \
               [[ "${{ steps.metadata.outputs.update-type }}" == "version-update:semver-minor" ]]; then
              SAFE="true"
              REASON="Dev dependency patch/minor update"
            fi
          fi
          
          # Auto-merge production patch updates (with breaking change check)
          if [[ "${{ steps.metadata.outputs.dependency-type }}" == "direct:production" ]]; then
            if [[ "${{ steps.metadata.outputs.update-type }}" == "version-update:semver-patch" ]]; then
              # Check for breaking changes mentioned in PR body
              if ! echo "${{ github.event.pull_request.body }}" | grep -iq "breaking"; then
                SAFE="true"
                REASON="Production patch update without breaking changes"
              else
                REASON="Breaking changes detected in patch update"
              fi
            fi
          fi
          
          # Extra validation for Next.js/React updates
          if [[ "${{ steps.metadata.outputs.dependency-names }}" =~ (next|react|react-dom) ]]; then
            if [[ "${{ steps.metadata.outputs.update-type }}" == "version-update:semver-patch" ]]; then
              if ! echo "${{ github.event.pull_request.body }}" | grep -iq "breaking"; then
                SAFE="true"
                REASON="Next.js/React patch without breaking changes"
              else
                SAFE="false"
                REASON="Next.js/React with breaking changes - requires review"
              fi
            else
              SAFE="false"
              REASON="Next.js/React minor/major update - requires review"
            fi
          fi
          
          echo "safe=$SAFE" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          echo "Decision: $SAFE - $REASON"
      
      - name: Wait for CI checks to complete
        if: steps.check.outputs.safe == 'true'
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          running-workflow-name: 'auto-merge'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 20
          allowed-conclusions: success
      
      - name: Auto-approve safe updates
        if: steps.check.outputs.safe == 'true'
        run: |
          gh pr review --approve "$PR_URL" --body "âœ… Auto-approved: ${{ steps.check.outputs.reason }}"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Enable auto-merge
        if: steps.check.outputs.safe == 'true'
        run: |
          gh pr merge --auto --squash "$PR_URL"
          echo "âœ… Auto-merge enabled for PR #${{ github.event.pull_request.number }}"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Add review required label
        if: steps.check.outputs.safe == 'false'
        run: |
          gh pr edit "$PR_URL" --add-label "review-required" --add-label "dependencies"
          gh pr comment "$PR_URL" --body "âš ï¸ **Manual review required**

This PR requires manual review because:
**${{ steps.check.outputs.reason }}**

Please review the changes before merging:
- Check CHANGELOG for breaking changes
- Verify compatibility with current codebase
- Test critical functionality locally

**Dependencies:** ${{ steps.metadata.outputs.dependency-names }}
**Update type:** ${{ steps.metadata.outputs.update-type }}"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on major version updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "ðŸš¨ **Major version update detected**
          
This PR contains a major version bump that likely includes breaking changes:
- **Review migration guides** for ${{ steps.metadata.outputs.dependency-names }}
- **Test thoroughly** before merging
- **Update code** as necessary for breaking changes
- **Check for deprecated APIs** that may have been removed"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          if [[ "${{ steps.check.outputs.safe }}" == "true" ]]; then
            echo "### âœ… Auto-merge enabled" >> $GITHUB_STEP_SUMMARY
            echo "This PR will be automatically merged once CI checks pass." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** ${{ steps.check.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Manual review required" >> $GITHUB_STEP_SUMMARY
            echo "This PR requires manual review before merging." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** ${{ steps.check.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency: ${{ steps.metadata.outputs.dependency-names }}" >> $GITHUB_STEP_SUMMARY
          echo "- Type: ${{ steps.metadata.outputs.dependency-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Update: ${{ steps.metadata.outputs.update-type }}" >> $GITHUB_STEP_SUMMARY
