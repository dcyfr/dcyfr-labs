name: PR Automation

# Auto-label PRs and add helpful comments based on PR size and changes
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions: {}

jobs:
  auto-label:
    name: Auto-label PR
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Auto-label PR based on changed files
        uses: actions/labeler@v5
        with:
          configuration-path: .github/labeler.yml
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  size-check:
    name: Check PR Size
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for proper diff

      - name: Analyze PR size
        id: size
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR details
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Get changed files count
          CHANGED_FILES=$(gh pr view $PR_NUMBER --json files -q '.files | length')

          # Get total lines changed
          ADDITIONS=$(gh pr view $PR_NUMBER --json additions -q '.additions')
          DELETIONS=$(gh pr view $PR_NUMBER --json deletions -q '.deletions')
          TOTAL_CHANGES=$((ADDITIONS + DELETIONS))

          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          echo "total_changes=$TOTAL_CHANGES" >> $GITHUB_OUTPUT

          # Determine size category
          SIZE="small"
          EMOJI="ðŸŸ¢"
          if [ $TOTAL_CHANGES -gt 1000 ] || [ $CHANGED_FILES -gt 50 ]; then
            SIZE="extra-large"
            EMOJI="ðŸ”´"
          elif [ $TOTAL_CHANGES -gt 500 ] || [ $CHANGED_FILES -gt 30 ]; then
            SIZE="large"
            EMOJI="ðŸŸ "
          elif [ $TOTAL_CHANGES -gt 200 ] || [ $CHANGED_FILES -gt 15 ]; then
            SIZE="medium"
            EMOJI="ðŸŸ¡"
          fi

          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

          echo "### PR Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Changed files: $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- Lines added: +$ADDITIONS" >> $GITHUB_STEP_SUMMARY
          echo "- Lines removed: -$DELETIONS" >> $GITHUB_STEP_SUMMARY
          echo "- Total changes: $TOTAL_CHANGES" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $EMOJI $SIZE" >> $GITHUB_STEP_SUMMARY

      - name: Add size label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SIZE="${{ steps.size.outputs.size }}"

          # Remove existing size labels
          gh pr edit $PR_NUMBER --remove-label "size/small" || true
          gh pr edit $PR_NUMBER --remove-label "size/medium" || true
          gh pr edit $PR_NUMBER --remove-label "size/large" || true
          gh pr edit $PR_NUMBER --remove-label "size/extra-large" || true

          # Add new size label
          gh pr edit $PR_NUMBER --add-label "size/$SIZE"

      - name: Comment on large PRs
        if: steps.size.outputs.size == 'large' || steps.size.outputs.size == 'extra-large'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          CHANGED_FILES=${{ steps.size.outputs.changed_files }}
          TOTAL_CHANGES=${{ steps.size.outputs.total_changes }}
          EMOJI=${{ steps.size.outputs.emoji }}

          # Check if we've already commented (avoid spam)
          EXISTING_COMMENT=$(gh pr view $PR_NUMBER --json comments -q '.comments[] | select(.author.login == "github-actions[bot]" and (.body | contains("large PR"))) | .id' | head -1)

          if [ -z "$EXISTING_COMMENT" ]; then
            echo "## Large PR Detected" > /tmp/pr-comment.md
            echo "" >> /tmp/pr-comment.md
            echo "This PR modifies $CHANGED_FILES files with $TOTAL_CHANGES total changes." >> /tmp/pr-comment.md
            echo "" >> /tmp/pr-comment.md
            echo "### Recommendations" >> /tmp/pr-comment.md
            echo "" >> /tmp/pr-comment.md
            echo "Large PRs are harder to review and more likely to introduce bugs." >> /tmp/pr-comment.md
            echo "" >> /tmp/pr-comment.md
            echo "Consider breaking this into smaller PRs for easier review." >> /tmp/pr-comment.md
            echo "" >> /tmp/pr-comment.md
            echo "Ideal PR size: Less than 400 lines changed, Less than 15 files modified" >> /tmp/pr-comment.md
            gh pr comment $PR_NUMBER --body-file /tmp/pr-comment.md
          fi

  add-reviewers:
    name: Auto-assign Reviewers
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
    # Only run if PR is not from dependabot
    if: github.event.pull_request.user.login != 'dependabot[bot]'

    steps:
      - name: Add reviewers based on CODEOWNERS
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # CODEOWNERS are automatically requested, but we can add team reviewers here if needed
          # For now, just ensure PR is ready for review

          echo "âœ… Code owners will be automatically requested for review" >> $GITHUB_STEP_SUMMARY

  first-time-contributor:
    name: Welcome First-Time Contributors
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check if first-time contributor
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_AUTHOR=${{ github.event.pull_request.user.login }}
          REPO=${{ github.repository }}

          # Check if this is the author's first PR (excluding dependabot)
          if [ "$PR_AUTHOR" != "dependabot[bot]" ]; then
            PR_COUNT=$(gh pr list --repo $REPO --author $PR_AUTHOR --state all --json number -q 'length')

            if [ "$PR_COUNT" -eq 1 ]; then
              echo "first_time=true" >> $GITHUB_OUTPUT
            else
              echo "first_time=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "first_time=false" >> $GITHUB_OUTPUT
          fi

      - name: Welcome first-time contributor
        if: steps.check.outputs.first_time == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          echo "## Welcome to dcyfr-labs!" > /tmp/welcome.md
          echo "" >> /tmp/welcome.md
          echo "Thank you for your first contribution!" >> /tmp/welcome.md
          echo "" >> /tmp/welcome.md
          echo "### What happens next?" >> /tmp/welcome.md
          echo "" >> /tmp/welcome.md
          echo "Automated checks will run (tests, linting, security scans) and code owners will be automatically assigned for review." >> /tmp/welcome.md
          echo "" >> /tmp/welcome.md
          echo "### Tips for a smooth review" >> /tmp/welcome.md
          echo "" >> /tmp/welcome.md
          echo "Make sure all CI checks pass. Respond to review feedback. Keep the PR focused. Update documentation if needed." >> /tmp/welcome.md
          echo "" >> /tmp/welcome.md
          echo "Thanks again for contributing!" >> /tmp/welcome.md
          gh pr comment $PR_NUMBER --body-file /tmp/welcome.md
