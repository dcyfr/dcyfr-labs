name: Claude Code Security Review

# Scoped to PRs only. Does NOT run on push to main — findings are actionable
# at PR time, not after merge.
#
# ⚠️  PROMPT INJECTION RISK: This workflow is not hardened against prompt
# injection attacks embedded in PR content. Before enabling for external
# contributors, ensure your repository requires maintainer approval for
# workflows from fork PRs:
# Settings → Actions → Fork pull request workflows → "Require approval for all
# external contributors"
#
# Activation: Add CLAUDE_API_KEY as a repository (or org) secret.
# The key must be enabled for both the Claude API and Claude Code usage.
# Apply for access at: https://claude.com/contact-sales/security

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write  # Required to post inline PR comments

jobs:
  security-review:
    name: Security Review (Claude Code)
    runs-on: ubuntu-latest

    # Only run when the secret is present — allows the workflow to exist in the
    # repo without breaking forks or PRs prior to access being granted.
    if: ${{ secrets.CLAUDE_API_KEY != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 2

      - name: Claude Code Security Review
        uses: anthropics/claude-code-security-review@main
        with:
          claude-api-key: $CLAUDE_API_KEY

          # Post inline comments on the PR with findings + remediation guidance.
          comment-pr: true

          # Upload full findings JSON as a workflow artifact for audit trail.
          upload-results: true

          # Use Opus for highest-accuracy analysis (default; downgrade to
          # claude-sonnet-4-5-20250929 to reduce cost once tuning is stable).
          claude-model: claude-opus-4-1-20250805

          # Timeout per analysis run (minutes). 20 is generous for PR diffs;
          # increase to 30 for large refactoring PRs if timeouts occur.
          claudecode-timeout: 20

          # Directories that don't contain application code to review.
          exclude-directories: >
            node_modules,
            .next,
            .vercel,
            coverage,
            playwright-report,
            reports,
            public,
            e2e,
            tests,
            docs,
            scripts

          # Only scan changed files per commit (reduces noise and cost on
          # PRs with many commits).
          run-every-commit: false

          # Organisation-specific false-positive filtering.
          # Controls what Claude deprioritises / ignores.
          false-positive-filtering-instructions: >
            .github/security/false-positive-instructions.md

          # Tech-stack-specific scan guidance to improve precision.
          custom-security-scan-instructions: >
            .github/security/custom-scan-instructions.md
      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v1
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          CLAUDE_API_KEY: op://CI-CD/dcyfr-labs-claude-api-key/credential

