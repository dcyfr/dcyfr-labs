name: Claude Code Linting & Analysis

# Trigger on PR creation/update or manual dispatch
on:
  pull_request:
    paths:
      - 'src/**'
      - '.claude/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  # Job 1: Type checking and basic linting
  type-check:
    runs-on: ubuntu-latest
    name: TypeScript & ESLint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

  # Job 2: Design token compliance audit
  design-token-audit:
    runs-on: ubuntu-latest
    name: Design Token Audit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run design token audit
        run: |
          bash scripts/claude-code-automation.sh design-token-audit
        continue-on-error: true

  # Job 3: Test coverage analysis
  test-coverage:
    runs-on: ubuntu-latest
    name: Test Coverage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:run -- --coverage
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # Job 4: Build verification
  build-check:
    runs-on: ubuntu-latest
    name: Build Verification

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build
        continue-on-error: true

  # Job 5: Summary report
  summary:
    runs-on: ubuntu-latest
    name: Summary Report
    needs: [type-check, design-token-audit, test-coverage, build-check]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate summary
        run: |
          echo "# Claude Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript: ${{ needs.type-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Design Tokens: ${{ needs.design-token-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Coverage: ${{ needs.test-coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Details" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY

  # Job 6: Comment on PR with results
  comment:
    runs-on: ubuntu-latest
    name: PR Comment
    needs: [type-check, design-token-audit, test-coverage, build-check]
    if: github.event_name == 'pull_request' && always()

    steps:
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              typeCheck: '${{ needs.type-check.result }}',
              designTokens: '${{ needs.design-token-audit.result }}',
              tests: '${{ needs.test-coverage.result }}',
              build: '${{ needs.build-check.result }}'
            };

            const statusEmoji = (status) => {
              return status === 'success' ? 'âœ…' : status === 'failure' ? 'âŒ' : 'âš ï¸';
            };

            const body = `## ğŸ¤– Claude Code Quality Check

            | Check | Status |
            |-------|--------|
            | TypeScript | ${statusEmoji(results.typeCheck)} ${results.typeCheck} |
            | Design Tokens | ${statusEmoji(results.designTokens)} ${results.designTokens} |
            | Tests | ${statusEmoji(results.tests)} ${results.tests} |
            | Build | ${statusEmoji(results.build)} ${results.build} |

            View the [full workflow run](${context.payload.pull_request.html_url}/checks) for details.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
