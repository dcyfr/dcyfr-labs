name: Sync Preview Branch

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force:
        description: 'Force sync even if preview is ahead'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Fetch all branches
        run: |
          git fetch origin main
          git fetch origin preview
      
      - name: Check if preview branch exists
        id: check_branch
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/preview; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Preview branch exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "❌ Preview branch does not exist"
          fi
      
      - name: Create preview branch if not exists
        if: steps.check_branch.outputs.exists == 'false'
        run: |
          git checkout -b preview
          git push origin preview
          echo "✅ Created preview branch from main"
      
      - name: Sync preview with main
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          git checkout preview
          
          # Check if preview is behind main
          BEHIND=$(git rev-list --count preview..origin/main)
          AHEAD=$(git rev-list --count origin/main..preview)
          
          echo "Preview is $BEHIND commits behind and $AHEAD commits ahead of main"
          
          if [ "$BEHIND" -eq 0 ]; then
            echo "✅ Preview is already up to date with main"
            echo "up_to_date=true" >> $GITHUB_ENV
            exit 0
          fi
          
          if [ "$AHEAD" -gt 0 ] && [ "${{ github.event.inputs.force }}" != "true" ]; then
            echo "⚠️  Preview is ahead of main by $AHEAD commits"
            echo "⚠️  Skipping sync to prevent losing preview changes"
            echo "⚠️  Run workflow manually with 'force' option to override"
            echo "up_to_date=false" >> $GITHUB_ENV
            echo "ahead=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # Merge main into preview
          if git merge origin/main --no-edit; then
            git push origin preview
            echo "✅ Successfully merged main into preview"
            echo "up_to_date=true" >> $GITHUB_ENV
          else
            echo "❌ Merge conflict detected"
            git merge --abort
            echo "up_to_date=false" >> $GITHUB_ENV
            echo "conflict=true" >> $GITHUB_ENV
          fi
      
      - name: Create issue on merge conflict
        if: env.conflict == 'true'
        run: |
          gh issue create \
            --title "⚠️ Preview branch sync failed - merge conflict" \
            --body "The automatic sync of the \`preview\` branch with \`main\` failed due to merge conflicts.

**Action required:**
\`\`\`bash
git checkout preview
git pull origin main
# Resolve conflicts
git push origin preview
\`\`\`

**Triggered by:** ${{ github.event_name }}
**Commit:** ${{ github.sha }}" \
            --label "automation" \
            --label "preview-branch"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on push if preview is ahead
        if: env.ahead == 'true' && github.event_name == 'push'
        run: |
          echo "Preview branch is ahead of main - manual intervention may be needed"
      
      - name: Summary
        run: |
          if [[ "${{ env.up_to_date }}" == "true" ]]; then
            echo "### ✅ Preview branch synced successfully" >> $GITHUB_STEP_SUMMARY
            echo "The preview branch is now up to date with main." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ env.conflict }}" == "true" ]]; then
            echo "### ❌ Merge conflict detected" >> $GITHUB_STEP_SUMMARY
            echo "The preview branch has conflicts with main that require manual resolution." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "An issue has been created to track this." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ env.ahead }}" == "true" ]]; then
            echo "### ⚠️ Preview branch is ahead of main" >> $GITHUB_STEP_SUMMARY
            echo "Sync skipped to prevent losing preview changes." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run manually with 'force' option to override." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ℹ️ No sync needed" >> $GITHUB_STEP_SUMMARY
            echo "The preview branch is already up to date." >> $GITHUB_STEP_SUMMARY
          fi
