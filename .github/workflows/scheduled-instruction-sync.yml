name: Scheduled AI Instruction Sync

# Run quarterly to capture latest project metrics and update instruction docs
on:
  schedule:
    # Every Monday at 9 AM on the first week of the month (quarterly approx)
    - cron: '0 9 ? * MON#1'
  
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  sync-instructions:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Sync AI instructions with current metrics
        run: npm run sync:ai
      
      - name: Validate instruction files
        run: node scripts/validation/validate-instructions.mjs
        continue-on-error: true
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            git diff --name-only
          fi
      
      - name: Create Pull Request with synced docs
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(docs): sync AI instructions with current metrics
            
            - Update test statistics
            - Refresh MCP server status
            - Capture latest design token compliance
            - Sync Lighthouse performance baselines
          title: 'chore(docs): quarterly sync of AI instructions and metrics'
          body: |
            ## Quarterly AI Instruction Sync
            
            This PR automatically syncs instruction documentation with current project state.
            
            **Changes:**
            - âœ… Test statistics updated
            - âœ… MCP server status refreshed
            - âœ… Design token compliance captured
            - âœ… Lighthouse baselines synced
            
            **Generated by:** `npm run sync:ai`
            **Schedule:** First Monday of each month at 9 AM PT
            
            Please review for accuracy and merge to keep documentation current.
          branch: 'chore/sync-ai-instructions'
          delete-branch: true
          labels: |
            documentation
            automated
            ai-instructions
          reviewers: |
            dcyfr
      
      - name: Summary
        run: |
          echo "### ðŸ“š AI Instruction Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.changed }}" == "true" ]]; then
            echo "âœ… Changes detected - Pull Request created" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No changes needed - Instructions are current" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Last sync:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
