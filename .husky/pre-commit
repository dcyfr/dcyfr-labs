#!/bin/bash
# Husky pre-commit hook with comprehensive governance checks
# Migrated from .githooks/pre-commit for better quality control

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

echo "üîç Running pre-commit governance checks..."

# Check 0: Gitleaks secret detection (PRIMARY DEFENSE)
echo -n "  Checking for secrets with gitleaks... "
if command -v gitleaks &> /dev/null; then
  if ! gitleaks protect --staged --redact --verbose=false --config=.gitleaks.toml > /dev/null 2>&1; then
    echo -e "${RED}FAIL${NC}"
    echo -e "${RED}‚ùå BLOCKED: Secrets detected in staged files!${NC}"
    echo ""
    echo "üîç Running detailed scan..."
    gitleaks protect --staged --redact --verbose=true --config=.gitleaks.toml
    echo ""
    echo "üìñ RULES:"
    echo "   1. NEVER commit API keys, tokens, or secrets"
    echo "   2. Use environment variables (.env.local)"
    echo "   3. Use placeholders: <your-secret-here>"
    echo "   4. Add legitimate examples to .gitleaksignore"
    echo ""
    echo "üí° To bypass (EMERGENCY ONLY): git commit --no-verify"
    ERRORS=$((ERRORS+1))
  else
    echo -e "${GREEN}PASS${NC}"
  fi
else
  echo -e "${YELLOW}SKIP${NC} (gitleaks not installed)"
  echo "   ‚ö†Ô∏è  Install with: brew install gitleaks"
  echo "   Continuing with fallback regex checks..."
fi

# Check 1: Sensitive files in public docs
echo -n "  Checking for sensitive files in public docs... "
SENSITIVE_FILES=$(git diff --cached --name-only --diff-filter=AM 2>/dev/null | grep -E "^docs/" | grep -v "^docs/private/" | grep -v "^docs/.*/private/" | grep -E "(FINDINGS|AUDIT|REPORT|ANALYSIS|METRICS|VULNERABILITY|STATUS|BACKLOG|COMPLETION|CAMPAIGN|PHASE[0-9])\.md$" || true)

if [ -n "$SENSITIVE_FILES" ]; then
  echo -e "${RED}FAIL${NC}"
  echo -e "${RED}‚ùå ERROR: Sensitive files detected in public docs/${NC}"
  echo "   These files should be in docs/private/ instead:"
  echo "$SENSITIVE_FILES" | sed 's/^/      /'
  echo ""
  ERRORS=$((ERRORS+1))
else
  echo -e "${GREEN}PASS${NC}"
fi

# Check 2: Enhanced credential detection (FALLBACK if gitleaks not installed)
echo -n "  Checking for hardcoded credentials (enhanced)... "
# Detect credentials in multiple formats:
# 1. Quoted: API_KEY="value" or API_KEY='value'
# 2. Unquoted: GITHUB_WEBHOOK_SECRET=base64value
# 3. Variable names containing secret keywords
# 4. Base64 strings >30 chars (likely secrets)
# 5. JWT tokens

SECRETS=$(git diff --cached -U0 2>/dev/null | \
  grep -v "^\+\+\+ b/.husky/" | \
  grep -v "^\+\+\+ b/scripts/ci/check-docs-secrets.mjs" | \
  grep -v "^\+\+\+ b/.gitleaksignore" | \
  grep -E "^\+" | \
  grep -v "^+++" | \
  grep -E "API_KEY.*=|SECRET.*=|PASSWORD.*=|TOKEN.*=|PRIVATE_KEY.*=" | \
  grep -v "<your-secret-here>" | \
  grep -v "your-api-key-here" | \
  grep -vE "YOUR_[A-Z_]+" | \
  grep -v "process\.env\." || true)

if [ -n "$SECRETS" ]; then
  echo -e "${RED}FAIL${NC}"
  echo -e "${RED}‚ùå ERROR: Potential hardcoded credentials detected!${NC}"
  echo ""
  echo "üîç Found suspicious patterns:"
  echo "$SECRETS" | head -20 | sed 's/^/      /'
  echo ""
  echo "üìñ RULES:"
  echo "   1. NEVER commit API keys, tokens, or secrets"
  echo "   2. Use environment variables (.env.local)"
  echo "   3. Use placeholders: <your-secret-here> or your-api-key-here"
  echo "   4. Add legitimate examples to .gitleaksignore"
  echo ""
  echo "üí° To bypass this check (if false positive): Add to .gitleaksignore"
  ERRORS=$((ERRORS+1))
else
  echo -e "${GREEN}PASS${NC}"
fi

# Check 3: Large files
echo -n "  Checking for suspiciously large files... "
LARGE_FILES=$(git diff --cached --name-only --diff-filter=A 2>/dev/null | while read FILE; do
  if [ -f "$FILE" ]; then
    SIZE=$(stat -f%z "$FILE" 2>/dev/null || stat -c%s "$FILE" 2>/dev/null || echo 0)
    if [ "$SIZE" -gt 5242880 ]; then  # 5MB
      echo "$FILE ($((SIZE/1048576))MB)"
    fi
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo -e "${YELLOW}WARN${NC}"
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Large files detected${NC}"
  echo "$LARGE_FILES" | sed 's/^/      /'
  WARNINGS=$((WARNINGS+1))
else
  echo -e "${GREEN}PASS${NC}"
fi

# Check 4: docs/private directory exists
echo -n "  Checking docs/private directory... "
if [ ! -d "docs/private" ]; then
  mkdir -p docs/private
  echo -e "${YELLOW}WARN${NC} (created)"
else
  echo -e "${GREEN}PASS${NC}"
fi

# Check 5: Misplaced operational docs
echo -n "  Checking for misplaced operational documents... "
OPERATIONAL=$(git diff --cached --name-only 2>/dev/null | grep -E "^docs/(ai|api|architecture|components|testing|templates)/" | grep -iE "(todo|status|backlog|operational|metrics)" || true)

if [ -n "$OPERATIONAL" ]; then
  echo -e "${YELLOW}WARN${NC}"
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Operational docs may belong in docs/private${NC}"
  echo "$OPERATIONAL" | sed 's/^/      /'
  WARNINGS=$((WARNINGS+1))
else
  echo -e "${GREEN}PASS${NC}"
fi

# Check 6: PI/PII scan on staged files
echo -n "  Scanning for Personal Information... "
if npm run scan:pi --silent 2>&1 | grep -q "violations"; then
  echo -e "${RED}FAIL${NC}"
  echo -e "${RED}‚ùå ERROR: PII/PI detected in staged files${NC}"
  npm run scan:pi 2>&1 | head -10 | sed 's/^/      /'
  ERRORS=$((ERRORS+1))
else
  echo -e "${GREEN}PASS${NC}"
fi

# Check 7: Design token compliance
echo -n "  Checking design token compliance... "
if command -v node &> /dev/null; then
  if node scripts/find-token-violations.mjs --check 2>/dev/null | grep -q "violations"; then
    echo -e "${YELLOW}WARN${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Design token violations detected${NC}"
    echo "   Run: npm run find:token-violations (to review)"
    echo "   Or: npm run fix:tokens (to auto-fix common patterns)"
    WARNINGS=$((WARNINGS+1))
  else
    echo -e "${GREEN}PASS${NC}"
  fi
else
  echo -e "${YELLOW}SKIP${NC} (node not available)"
fi

# Check 8: Test data in production code
echo -n "  Checking for test data in production... "
if command -v node &> /dev/null; then
  TEST_DATA_OUTPUT=$(node scripts/check-test-data.mjs 2>/dev/null || true)
  if echo "$TEST_DATA_OUTPUT" | grep -q "CRITICAL"; then
    echo -e "${RED}FAIL${NC}"
    echo -e "${RED}‚ùå ERROR: Test data detected in production code${NC}"
    echo "$TEST_DATA_OUTPUT" | head -10 | sed 's/^/      /'
    ERRORS=$((ERRORS+1))
  else
    echo -e "${GREEN}PASS${NC}"
  fi
else
  echo -e "${YELLOW}SKIP${NC} (node not available)"
fi

# Check 9: Documentation placement validation
echo -n "  Checking documentation placement... "
# FIX: Copilot suggestion - Use single extended regex instead of chained grep -v calls
# Allow README.md files anywhere (contextual documentation), exclude workspace README
ROOT_DOCS=$(git diff --cached --name-only --diff-filter=AM 2>/dev/null | grep -E "\.md$" | grep -vE '^(docs/|.*README\.md$|CONTRIBUTING\.md$|CHANGELOG\.md$|LICENSE\.md$|SECURITY\.md$|AGENTS\.md$|CLAUDE\.md$|\.github/.*\.md$|\.opencode/.*\.md$|\.claude/.*\.md$|\.agent/.*\.md$)' || true)

if [ -n "$ROOT_DOCS" ]; then
  echo -e "${RED}FAIL${NC}"
  echo -e "${RED}‚ùå ERROR: Documentation files found outside /docs folder${NC}"
  echo "   These files must be in docs/ subdirectories:"
  echo "$ROOT_DOCS" | sed 's/^/      /'
  echo ""
  echo "   Guidelines:"
  echo "      - Analysis docs ‚Üí docs/analysis/"
  echo "      - Reports ‚Üí docs/[category]/private/"
  echo "      - Guides ‚Üí docs/[category]/"
  echo "      - Sensitive ‚Üí docs/[category]/private/"
  echo ""
  echo "   See: docs/governance/AGENT_DOCUMENTATION_ENFORCEMENT.md"
  ERRORS=$((ERRORS+1))
else
  echo -e "${GREEN}PASS${NC}"
fi

# Check 10: ESLint and lint-staged
echo -n "  Running ESLint and lint-staged... "
# Skip lint-staged while ESLint configuration is being stabilized
# Linting enforcement moved to CI/CD pipeline
echo -e "${YELLOW}SKIP${NC} (moved to CI/CD)"
# Allow all commits - linting enforced in CI
WARNINGS=$((WARNINGS+1))

# Check 11: Frontmatter validation for blog posts
echo -n "  Validating blog post frontmatter... "
CHANGED_POSTS=$(git diff --cached --name-only 2>/dev/null | grep "^src/content/blog/.*\.mdx$" || true)
if [ -n "$CHANGED_POSTS" ]; then
  if tsx scripts/validate-frontmatter.mjs 2>&1 | grep -q "failed validation"; then
    echo -e "${RED}FAIL${NC}"
    echo -e "${RED}‚ùå ERROR: Blog post frontmatter validation failed${NC}"
    tsx scripts/validate-frontmatter.mjs 2>&1 | tail -20 | sed 's/^/      /'
    ERRORS=$((ERRORS+1))
  else
    echo -e "${GREEN}PASS${NC}"
  fi
else
  echo -e "${YELLOW}SKIP${NC} (no blog posts changed)"
fi

# Check 12: Footnote validation for blog posts
echo -n "  Validating blog post footnotes... "
if [ -n "$CHANGED_POSTS" ]; then
  if node scripts/validate-footnotes.mjs 2>&1 | grep -q "failed validation"; then
    echo -e "${RED}FAIL${NC}"
    echo -e "${RED}‚ùå ERROR: Blog post footnote validation failed${NC}"
    node scripts/validate-footnotes.mjs 2>&1 | tail -20 | sed 's/^/      /'
    ERRORS=$((ERRORS+1))
  else
    echo -e "${GREEN}PASS${NC}"
  fi
else
  echo -e "${YELLOW}SKIP${NC} (no blog posts changed)"
fi

# Check 13: Documentation secret scanner
echo -n "  Scanning documentation for secrets... "
CHANGED_DOCS=$(git diff --cached --name-only 2>/dev/null | grep -E "\.md$" || true)
if [ -n "$CHANGED_DOCS" ]; then
  if command -v node &> /dev/null; then
    if node scripts/ci/check-docs-secrets.mjs 2>&1 | grep -q "SECRETS DETECTED"; then
      echo -e "${RED}FAIL${NC}"
      echo -e "${RED}‚ùå ERROR: Secrets detected in documentation!${NC}"
      node scripts/ci/check-docs-secrets.mjs 2>&1 | tail -30 | sed 's/^/      /'
      ERRORS=$((ERRORS+1))
    else
      echo -e "${GREEN}PASS${NC}"
    fi
  else
    echo -e "${YELLOW}SKIP${NC} (node not available)"
  fi
else
  echo -e "${YELLOW}SKIP${NC} (no documentation changed)"
fi

# Summary
echo ""
echo "üìä Summary:"
if [ $ERRORS -eq 0 ]; then
  echo -e "${GREEN}‚úÖ No errors found${NC}"
else
  echo -e "${RED}‚ùå $ERRORS error(s) found${NC}"
fi

if [ $WARNINGS -gt 0 ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  $WARNINGS warning(s) found${NC}"
fi

echo ""

# Check: Design Token Validation
echo -n "  Validating design token usage... "
if [ -f "scripts/validate-design-tokens.mjs" ]; then
  if node scripts/validate-design-tokens.mjs > /dev/null 2>&1; then
    echo -e "${GREEN}PASS${NC}"
  else
    echo -e "${RED}FAIL${NC}"
    echo -e "${RED}‚ùå ERROR: Design token validation failed!${NC}"
    echo ""
    echo "üîç Running validation for details..."
    node scripts/validate-design-tokens.mjs
    echo ""
    echo "üìñ See: docs/design/DESIGN_TOKEN_USAGE_GUIDE.md"
    ERRORS=$((ERRORS+1))
  fi
else
  echo -e "${YELLOW}SKIP${NC} (validator not found)"
fi

# Check: Lint-staged (ESLint + Prettier)
echo -n "  Running lint-staged (ESLint + Prettier)... "
if command -v npx &> /dev/null && [ -f ".lintstagedrc.json" ]; then
  if npx lint-staged > /dev/null 2>&1; then
    echo -e "${GREEN}PASS${NC}"
  else
    echo -e "${RED}FAIL${NC}"
    echo -e "${RED}‚ùå ERROR: Linting or formatting issues detected!${NC}"
    echo ""
    echo "üîç Running lint-staged for details..."
    npx lint-staged
    echo ""
    echo "üí° Many issues can be auto-fixed with: npm run lint:fix"
    ERRORS=$((ERRORS+1))
  fi
else
  echo -e "${YELLOW}SKIP${NC} (lint-staged not available)"
fi

echo ""

# Exit with error if there are violations
if [ $ERRORS -gt 0 ]; then
  echo -e "${RED}Commit blocked due to governance violations.${NC}"
  echo "See docs/governance/DOCS_GOVERNANCE.md for guidelines."
  exit 1
fi

exit 0
